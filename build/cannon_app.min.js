/**
 * almond 0.2.5 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

//     Underscore.js 1.4.4
//     http://underscorejs.org
//     (c) 2009-2013 Jeremy Ashkenas, DocumentCloud Inc.
//     Underscore may be freely distributed under the MIT license.

/*
Copyright (c) 2013 Verold Inc.

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
*/

/*
 * Copyright (c) 2012 cannon.js Authors
 * 
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use, copy,
 * modify, merge, publish, distribute, sublicense, and/or sell copies
 * of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */

(function(t,e){"function"==typeof define&&define.amd?define(e):t.VAPI.CannonApp=e()})(this,function(){var t,e,i;return function(n){function r(t,e){return b.call(t,e)}function o(t,e){var i,n,r,o,a,s,u,c,l,h,p=e&&e.split("/"),d=w.map,v=d&&d["*"]||{};if(t&&"."===t.charAt(0))if(e){for(p=p.slice(0,p.length-1),t=p.concat(t.split("/")),c=0;t.length>c;c+=1)if(h=t[c],"."===h)t.splice(c,1),c-=1;else if(".."===h){if(1===c&&(".."===t[2]||".."===t[0]))break;c>0&&(t.splice(c-1,2),c-=2)}t=t.join("/")}else 0===t.indexOf("./")&&(t=t.substring(2));if((p||v)&&d){for(i=t.split("/"),c=i.length;c>0;c-=1){if(n=i.slice(0,c).join("/"),p)for(l=p.length;l>0;l-=1)if(r=d[p.slice(0,l).join("/")],r&&(r=r[n])){o=r,a=c;break}if(o)break;!s&&v&&v[n]&&(s=v[n],u=c)}!o&&s&&(o=s,a=u),o&&(i.splice(0,a,o),t=i.join("/"))}return t}function a(t,e){return function(){return d.apply(n,x.call(arguments,0).concat([t,e]))}}function s(t){return function(e){return o(e,t)}}function u(t){return function(e){y[t]=e}}function c(t){if(r(m,t)){var e=m[t];delete m[t],g[t]=!0,p.apply(n,e)}if(!r(y,t)&&!r(g,t))throw Error("No "+t);return y[t]}function l(t){var e,i=t?t.indexOf("!"):-1;return i>-1&&(e=t.substring(0,i),t=t.substring(i+1,t.length)),[e,t]}function h(t){return function(){return w&&w.config&&w.config[t]||{}}}var p,d,v,f,y={},m={},w={},g={},b=Object.prototype.hasOwnProperty,x=[].slice;v=function(t,e){var i,n=l(t),r=n[0];return t=n[1],r&&(r=o(r,e),i=c(r)),r?t=i&&i.normalize?i.normalize(t,s(e)):o(t,e):(t=o(t,e),n=l(t),r=n[0],t=n[1],r&&(i=c(r))),{f:r?r+"!"+t:t,n:t,pr:r,p:i}},f={require:function(t){return a(t)},exports:function(t){var e=y[t];return e!==void 0?e:y[t]={}},module:function(t){return{id:t,uri:"",exports:y[t],config:h(t)}}},p=function(t,e,i,o){var s,l,h,p,d,w,b=[];if(o=o||t,"function"==typeof i){for(e=!e.length&&i.length?["require","exports","module"]:e,d=0;e.length>d;d+=1)if(p=v(e[d],o),l=p.f,"require"===l)b[d]=f.require(t);else if("exports"===l)b[d]=f.exports(t),w=!0;else if("module"===l)s=b[d]=f.module(t);else if(r(y,l)||r(m,l)||r(g,l))b[d]=c(l);else{if(!p.p)throw Error(t+" missing "+l);p.p.load(p.n,a(o,!0),u(l),{}),b[d]=y[l]}h=i.apply(y[t],b),t&&(s&&s.exports!==n&&s.exports!==y[t]?y[t]=s.exports:h===n&&w||(y[t]=h))}else t&&(y[t]=i)},t=e=d=function(t,e,i,r,o){return"string"==typeof t?f[t]?f[t](e):c(v(t,e).f):(t.splice||(w=t,e.splice?(t=e,e=i,i=null):t=n),e=e||function(){},"function"==typeof i&&(i=r,r=o),r?p(n,t,e,i):setTimeout(function(){p(n,t,e,i)},4),d)},d.config=function(t){return w=t,w.deps&&d(w.deps,w.callback),d},i=function(t,e,i){e.splice||(i=e,e=[]),r(y,t)||r(m,t)||(m[t]=[t,e,i])},i.amd={jQuery:!0}}(),i("vendor/almond",function(){}),function(){var t=this,e=t._,n={},r=Array.prototype,o=Object.prototype,a=Function.prototype,s=r.push,u=r.slice,c=r.concat,l=o.toString,h=o.hasOwnProperty,p=r.forEach,d=r.map,v=r.reduce,f=r.reduceRight,y=r.filter,m=r.every,w=r.some,g=r.indexOf,b=r.lastIndexOf,x=Array.isArray,V=Object.keys,E=a.bind,z=function(t){return t instanceof z?t:this instanceof z?(this._wrapped=t,void 0):new z(t)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=z),exports._=z):t._=z,z.VERSION="1.4.4";var S=z.each=z.forEach=function(t,e,i){if(null!=t)if(p&&t.forEach===p)t.forEach(e,i);else if(t.length===+t.length){for(var r=0,o=t.length;o>r;r++)if(e.call(i,t[r],r,t)===n)return}else for(var a in t)if(z.has(t,a)&&e.call(i,t[a],a,t)===n)return};z.map=z.collect=function(t,e,i){var n=[];return null==t?n:d&&t.map===d?t.map(e,i):(S(t,function(t,r,o){n[n.length]=e.call(i,t,r,o)}),n)};var N="Reduce of empty array with no initial value";z.reduce=z.foldl=z.inject=function(t,e,i,n){var r=arguments.length>2;if(null==t&&(t=[]),v&&t.reduce===v)return n&&(e=z.bind(e,n)),r?t.reduce(e,i):t.reduce(e);if(S(t,function(t,o,a){r?i=e.call(n,i,t,o,a):(i=t,r=!0)}),!r)throw new TypeError(N);return i},z.reduceRight=z.foldr=function(t,e,i,n){var r=arguments.length>2;if(null==t&&(t=[]),f&&t.reduceRight===f)return n&&(e=z.bind(e,n)),r?t.reduceRight(e,i):t.reduceRight(e);var o=t.length;if(o!==+o){var a=z.keys(t);o=a.length}if(S(t,function(s,u,c){u=a?a[--o]:--o,r?i=e.call(n,i,t[u],u,c):(i=t[u],r=!0)}),!r)throw new TypeError(N);return i},z.find=z.detect=function(t,e,i){var n;return M(t,function(t,r,o){return e.call(i,t,r,o)?(n=t,!0):void 0}),n},z.filter=z.select=function(t,e,i){var n=[];return null==t?n:y&&t.filter===y?t.filter(e,i):(S(t,function(t,r,o){e.call(i,t,r,o)&&(n[n.length]=t)}),n)},z.reject=function(t,e,i){return z.filter(t,function(t,n,r){return!e.call(i,t,n,r)},i)},z.every=z.all=function(t,e,i){e||(e=z.identity);var r=!0;return null==t?r:m&&t.every===m?t.every(e,i):(S(t,function(t,o,a){return(r=r&&e.call(i,t,o,a))?void 0:n}),!!r)};var M=z.some=z.any=function(t,e,i){e||(e=z.identity);var r=!1;return null==t?r:w&&t.some===w?t.some(e,i):(S(t,function(t,o,a){return r||(r=e.call(i,t,o,a))?n:void 0}),!!r)};z.contains=z.include=function(t,e){return null==t?!1:g&&t.indexOf===g?-1!=t.indexOf(e):M(t,function(t){return t===e})},z.invoke=function(t,e){var i=u.call(arguments,2),n=z.isFunction(e);return z.map(t,function(t){return(n?e:t[e]).apply(t,i)})},z.pluck=function(t,e){return z.map(t,function(t){return t[e]})},z.where=function(t,e,i){return z.isEmpty(e)?i?null:[]:z[i?"find":"filter"](t,function(t){for(var i in e)if(e[i]!==t[i])return!1;return!0})},z.findWhere=function(t,e){return z.where(t,e,!0)},z.max=function(t,e,i){if(!e&&z.isArray(t)&&t[0]===+t[0]&&65535>t.length)return Math.max.apply(Math,t);if(!e&&z.isEmpty(t))return-1/0;var n={computed:-1/0,value:-1/0};return S(t,function(t,r,o){var a=e?e.call(i,t,r,o):t;a>=n.computed&&(n={value:t,computed:a})}),n.value},z.min=function(t,e,i){if(!e&&z.isArray(t)&&t[0]===+t[0]&&65535>t.length)return Math.min.apply(Math,t);if(!e&&z.isEmpty(t))return 1/0;var n={computed:1/0,value:1/0};return S(t,function(t,r,o){var a=e?e.call(i,t,r,o):t;n.computed>a&&(n={value:t,computed:a})}),n.value},z.shuffle=function(t){var e,i=0,n=[];return S(t,function(t){e=z.random(i++),n[i-1]=n[e],n[e]=t}),n};var j=function(t){return z.isFunction(t)?t:function(e){return e[t]}};z.sortBy=function(t,e,i){var n=j(e);return z.pluck(z.map(t,function(t,e,r){return{value:t,index:e,criteria:n.call(i,t,e,r)}}).sort(function(t,e){var i=t.criteria,n=e.criteria;if(i!==n){if(i>n||void 0===i)return 1;if(n>i||void 0===n)return-1}return t.index<e.index?-1:1}),"value")};var P=function(t,e,i,n){var r={},o=j(e||z.identity);return S(t,function(e,a){var s=o.call(i,e,a,t);n(r,s,e)}),r};z.groupBy=function(t,e,i){return P(t,e,i,function(t,e,i){(z.has(t,e)?t[e]:t[e]=[]).push(i)})},z.countBy=function(t,e,i){return P(t,e,i,function(t,e){z.has(t,e)||(t[e]=0),t[e]++})},z.sortedIndex=function(t,e,i,n){i=null==i?z.identity:j(i);for(var r=i.call(n,e),o=0,a=t.length;a>o;){var s=o+a>>>1;r>i.call(n,t[s])?o=s+1:a=s}return o},z.toArray=function(t){return t?z.isArray(t)?u.call(t):t.length===+t.length?z.map(t,z.identity):z.values(t):[]},z.size=function(t){return null==t?0:t.length===+t.length?t.length:z.keys(t).length},z.first=z.head=z.take=function(t,e,i){return null==t?void 0:null==e||i?t[0]:u.call(t,0,e)},z.initial=function(t,e,i){return u.call(t,0,t.length-(null==e||i?1:e))},z.last=function(t,e,i){return null==t?void 0:null==e||i?t[t.length-1]:u.call(t,Math.max(t.length-e,0))},z.rest=z.tail=z.drop=function(t,e,i){return u.call(t,null==e||i?1:e)},z.compact=function(t){return z.filter(t,z.identity)};var q=function(t,e,i){return S(t,function(t){z.isArray(t)?e?s.apply(i,t):q(t,e,i):i.push(t)}),i};z.flatten=function(t,e){return q(t,e,[])},z.without=function(t){return z.difference(t,u.call(arguments,1))},z.uniq=z.unique=function(t,e,i,n){z.isFunction(e)&&(n=i,i=e,e=!1);var r=i?z.map(t,i,n):t,o=[],a=[];return S(r,function(i,n){(e?n&&a[a.length-1]===i:z.contains(a,i))||(a.push(i),o.push(t[n]))}),o},z.union=function(){return z.uniq(c.apply(r,arguments))},z.intersection=function(t){var e=u.call(arguments,1);return z.filter(z.uniq(t),function(t){return z.every(e,function(e){return z.indexOf(e,t)>=0})})},z.difference=function(t){var e=c.apply(r,u.call(arguments,1));return z.filter(t,function(t){return!z.contains(e,t)})},z.zip=function(){for(var t=u.call(arguments),e=z.max(z.pluck(t,"length")),i=Array(e),n=0;e>n;n++)i[n]=z.pluck(t,""+n);return i},z.object=function(t,e){if(null==t)return{};for(var i={},n=0,r=t.length;r>n;n++)e?i[t[n]]=e[n]:i[t[n][0]]=t[n][1];return i},z.indexOf=function(t,e,i){if(null==t)return-1;var n=0,r=t.length;if(i){if("number"!=typeof i)return n=z.sortedIndex(t,e),t[n]===e?n:-1;n=0>i?Math.max(0,r+i):i}if(g&&t.indexOf===g)return t.indexOf(e,i);for(;r>n;n++)if(t[n]===e)return n;return-1},z.lastIndexOf=function(t,e,i){if(null==t)return-1;var n=null!=i;if(b&&t.lastIndexOf===b)return n?t.lastIndexOf(e,i):t.lastIndexOf(e);for(var r=n?i:t.length;r--;)if(t[r]===e)return r;return-1},z.range=function(t,e,i){1>=arguments.length&&(e=t||0,t=0),i=arguments[2]||1;for(var n=Math.max(Math.ceil((e-t)/i),0),r=0,o=Array(n);n>r;)o[r++]=t,t+=i;return o},z.bind=function(t,e){if(t.bind===E&&E)return E.apply(t,u.call(arguments,1));var i=u.call(arguments,2);return function(){return t.apply(e,i.concat(u.call(arguments)))}},z.partial=function(t){var e=u.call(arguments,1);return function(){return t.apply(this,e.concat(u.call(arguments)))}},z.bindAll=function(t){var e=u.call(arguments,1);return 0===e.length&&(e=z.functions(t)),S(e,function(e){t[e]=z.bind(t[e],t)}),t},z.memoize=function(t,e){var i={};return e||(e=z.identity),function(){var n=e.apply(this,arguments);return z.has(i,n)?i[n]:i[n]=t.apply(this,arguments)}},z.delay=function(t,e){var i=u.call(arguments,2);return setTimeout(function(){return t.apply(null,i)},e)},z.defer=function(t){return z.delay.apply(z,[t,1].concat(u.call(arguments,1)))},z.throttle=function(t,e){var i,n,r,o,a=0,s=function(){a=new Date,r=null,o=t.apply(i,n)};return function(){var u=new Date,c=e-(u-a);return i=this,n=arguments,0>=c?(clearTimeout(r),r=null,a=u,o=t.apply(i,n)):r||(r=setTimeout(s,c)),o}},z.debounce=function(t,e,i){var n,r;return function(){var o=this,a=arguments,s=function(){n=null,i||(r=t.apply(o,a))},u=i&&!n;return clearTimeout(n),n=setTimeout(s,e),u&&(r=t.apply(o,a)),r}},z.once=function(t){var e,i=!1;return function(){return i?e:(i=!0,e=t.apply(this,arguments),t=null,e)}},z.wrap=function(t,e){return function(){var i=[t];return s.apply(i,arguments),e.apply(this,i)}},z.compose=function(){var t=arguments;return function(){for(var e=arguments,i=t.length-1;i>=0;i--)e=[t[i].apply(this,e)];return e[0]}},z.after=function(t,e){return 0>=t?e():function(){return 1>--t?e.apply(this,arguments):void 0}},z.keys=V||function(t){if(t!==Object(t))throw new TypeError("Invalid object");var e=[];for(var i in t)z.has(t,i)&&(e[e.length]=i);return e},z.values=function(t){var e=[];for(var i in t)z.has(t,i)&&e.push(t[i]);return e},z.pairs=function(t){var e=[];for(var i in t)z.has(t,i)&&e.push([i,t[i]]);return e},z.invert=function(t){var e={};for(var i in t)z.has(t,i)&&(e[t[i]]=i);return e},z.functions=z.methods=function(t){var e=[];for(var i in t)z.isFunction(t[i])&&e.push(i);return e.sort()},z.extend=function(t){return S(u.call(arguments,1),function(e){if(e)for(var i in e)t[i]=e[i]}),t},z.pick=function(t){var e={},i=c.apply(r,u.call(arguments,1));return S(i,function(i){i in t&&(e[i]=t[i])}),e},z.omit=function(t){var e={},i=c.apply(r,u.call(arguments,1));for(var n in t)z.contains(i,n)||(e[n]=t[n]);return e},z.defaults=function(t){return S(u.call(arguments,1),function(e){if(e)for(var i in e)null==t[i]&&(t[i]=e[i])}),t},z.clone=function(t){return z.isObject(t)?z.isArray(t)?t.slice():z.extend({},t):t},z.tap=function(t,e){return e(t),t};var A=function(t,e,i,n){if(t===e)return 0!==t||1/t==1/e;if(null==t||null==e)return t===e;t instanceof z&&(t=t._wrapped),e instanceof z&&(e=e._wrapped);var r=l.call(t);if(r!=l.call(e))return!1;switch(r){case"[object String]":return t==e+"";case"[object Number]":return t!=+t?e!=+e:0==t?1/t==1/e:t==+e;case"[object Date]":case"[object Boolean]":return+t==+e;case"[object RegExp]":return t.source==e.source&&t.global==e.global&&t.multiline==e.multiline&&t.ignoreCase==e.ignoreCase}if("object"!=typeof t||"object"!=typeof e)return!1;for(var o=i.length;o--;)if(i[o]==t)return n[o]==e;i.push(t),n.push(e);var a=0,s=!0;if("[object Array]"==r){if(a=t.length,s=a==e.length)for(;a--&&(s=A(t[a],e[a],i,n)););}else{var u=t.constructor,c=e.constructor;if(u!==c&&!(z.isFunction(u)&&u instanceof u&&z.isFunction(c)&&c instanceof c))return!1;for(var h in t)if(z.has(t,h)&&(a++,!(s=z.has(e,h)&&A(t[h],e[h],i,n))))break;if(s){for(h in e)if(z.has(e,h)&&!a--)break;s=!a}}return i.pop(),n.pop(),s};z.isEqual=function(t,e){return A(t,e,[],[])},z.isEmpty=function(t){if(null==t)return!0;if(z.isArray(t)||z.isString(t))return 0===t.length;for(var e in t)if(z.has(t,e))return!1;return!0},z.isElement=function(t){return!(!t||1!==t.nodeType)},z.isArray=x||function(t){return"[object Array]"==l.call(t)},z.isObject=function(t){return t===Object(t)},S(["Arguments","Function","String","Number","Date","RegExp"],function(t){z["is"+t]=function(e){return l.call(e)=="[object "+t+"]"}}),z.isArguments(arguments)||(z.isArguments=function(t){return!(!t||!z.has(t,"callee"))}),z.isFunction=function(t){return"function"==typeof t},z.isFinite=function(t){return isFinite(t)&&!isNaN(parseFloat(t))},z.isNaN=function(t){return z.isNumber(t)&&t!=+t},z.isBoolean=function(t){return t===!0||t===!1||"[object Boolean]"==l.call(t)},z.isNull=function(t){return null===t},z.isUndefined=function(t){return void 0===t},z.has=function(t,e){return h.call(t,e)},z.noConflict=function(){return t._=e,this},z.identity=function(t){return t},z.times=function(t,e,i){for(var n=Array(t),r=0;t>r;r++)n[r]=e.call(i,r);return n},z.random=function(t,e){return null==e&&(e=t,t=0),t+Math.floor(Math.random()*(e-t+1))};var I={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};I.unescape=z.invert(I.escape);var B={escape:RegExp("["+z.keys(I.escape).join("")+"]","g"),unescape:RegExp("("+z.keys(I.unescape).join("|")+")","g")};z.each(["escape","unescape"],function(t){z[t]=function(e){return null==e?"":(""+e).replace(B[t],function(e){return I[t][e]})}}),z.result=function(t,e){if(null==t)return null;var i=t[e];return z.isFunction(i)?i.call(t):i},z.mixin=function(t){S(z.functions(t),function(e){var i=z[e]=t[e];z.prototype[e]=function(){var t=[this._wrapped];return s.apply(t,arguments),F.call(this,i.apply(z,t))}})};var C=0;z.uniqueId=function(t){var e=++C+"";return t?t+e:e},z.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var O=/(.)^/,R={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},T=/\\|'|\r|\n|\t|\u2028|\u2029/g;z.template=function(t,e,i){var n;i=z.defaults({},i,z.templateSettings);var r=RegExp([(i.escape||O).source,(i.interpolate||O).source,(i.evaluate||O).source].join("|")+"|$","g"),o=0,a="__p+='";t.replace(r,function(e,i,n,r,s){return a+=t.slice(o,s).replace(T,function(t){return"\\"+R[t]}),i&&(a+="'+\n((__t=("+i+"))==null?'':_.escape(__t))+\n'"),n&&(a+="'+\n((__t=("+n+"))==null?'':__t)+\n'"),r&&(a+="';\n"+r+"\n__p+='"),o=s+e.length,e}),a+="';\n",i.variable||(a="with(obj||{}){\n"+a+"}\n"),a="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+a+"return __p;\n";try{n=Function(i.variable||"obj","_",a)}catch(s){throw s.source=a,s}if(e)return n(e,z);var u=function(t){return n.call(this,t,z)};return u.source="function("+(i.variable||"obj")+"){\n"+a+"}",u},z.chain=function(t){return z(t).chain()};var F=function(t){return this._chain?z(t).chain():t};z.mixin(z),S(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var e=r[t];z.prototype[t]=function(){var i=this._wrapped;return e.apply(i,arguments),"shift"!=t&&"splice"!=t||0!==i.length||delete i[0],F.call(this,i)}}),S(["concat","join","slice"],function(t){var e=r[t];z.prototype[t]=function(){return F.call(this,e.apply(this._wrapped,arguments))}}),z.extend(z.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}}),"function"==typeof i&&i.amd&&i("underscore",[],function(){return z})}.call(this),i("mesh",["underscore"],function(t){function e(t,e,i){i=i||{},this.world=t,this.model=e,this.mass=1,this.linearDamping=i.linearDamping||this.linearDamping||.9,this.angularDamping=i.angularDamping||this.angularDamping||.9,i.mass?this.mass=i.mass:e.entityModel.has("payload.userData.mass")&&(this.mass=e.entityModel.get("payload.userData.mass")),this.create()}if(window.VAPI===void 0||window.VAPI.VeroldApp===void 0)throw Error("VAPI.VeroldApp does not exist!");return t.extend(e.prototype,{create:function(){throw Error("Not implemented")},update:function(){this.model.cannonData.position.copy(this.model.threeData.position),this.model.cannonData.quaternion.copy(this.model.threeData.quaternion)},created:function(){}}),e}),function(){var t=t||{};this.Int32Array||(this.Int32Array=Array,this.Float32Array=Array),t.Mat3=function(t){this.elements=t?t:[0,0,0,0,0,0,0,0,0]},t.Mat3.prototype.identity=function(){this.elements[0]=1,this.elements[1]=0,this.elements[2]=0,this.elements[3]=0,this.elements[4]=1,this.elements[5]=0,this.elements[6]=0,this.elements[7]=0,this.elements[8]=1},t.Mat3.prototype.setZero=function(){var t=this.elements;t[0]=0,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t[8]=0},t.Mat3.prototype.setTrace=function(t){var e=this.elements;e[0]=t.x,e[4]=t.y,e[8]=t.z},t.Mat3.prototype.vmult=function(e,i){i=i||new t.Vec3;var n=this.elements,r=e.x,o=e.y,a=e.z;return i.x=n[0]*r+n[1]*o+n[2]*a,i.y=n[3]*r+n[4]*o+n[5]*a,i.z=n[6]*r+n[7]*o+n[8]*a,i},t.Mat3.prototype.smult=function(t){for(var e=0;this.elements.length>e;e++)this.elements[e]*=t},t.Mat3.prototype.mmult=function(e){for(var i=new t.Mat3,n=0;3>n;n++)for(var r=0;3>r;r++){for(var o=0,a=0;3>a;a++)o+=e.elements[n+3*a]*this.elements[a+3*r];i.elements[n+3*r]=o}return i},t.Mat3.prototype.solve=function(e,i){i=i||new t.Vec3;for(var n=3,r=4,o=[],a=0;n*r>a;a++)o.push(0);var a,s;for(a=0;3>a;a++)for(s=0;3>s;s++)o[a+r*s]=this.elements[a+3*s];o[3]=e.x,o[7]=e.y,o[11]=e.z;var u,c,l=3,h=l,p=4;do{if(a=h-l,0===o[a+r*a])for(s=a+1;h>s;s++)if(0!==o[a+r*s]){u=p;do c=p-u,o[c+r*a]+=o[c+r*s];while(--u);break}if(0!==o[a+r*a])for(s=a+1;h>s;s++){var d=o[a+r*s]/o[a+r*a];u=p;do c=p-u,o[c+r*s]=a>=c?0:o[c+r*s]-o[c+r*a]*d;while(--u)}}while(--l);if(i.z=o[2*r+3]/o[2*r+2],i.y=(o[1*r+3]-o[1*r+2]*i.z)/o[1*r+1],i.x=(o[0*r+3]-o[0*r+2]*i.z-o[0*r+1]*i.y)/o[0*r+0],isNaN(i.x)||isNaN(i.y)||isNaN(i.z)||1/0===i.x||1/0===i.y||1/0===i.z)throw"Could not solve equation! Got x=["+(""+i)+"], b=["+(""+e)+"], A=["+(""+this)+"]";return i},t.Mat3.prototype.e=function(t,e,i){return void 0===i?this.elements[e+3*t]:(this.elements[e+3*t]=i,void 0)},t.Mat3.prototype.copy=function(e){e=e||new t.Mat3;for(var i=0;this.elements.length>i;i++)e.elements[i]=this.elements[i];return e},t.Mat3.prototype.toString=function(){for(var t="",e=",",i=0;9>i;i++)t+=this.elements[i]+e;return t},t.Mat3.prototype.reverse=function(e){e=e||new t.Mat3;for(var i=3,n=6,r=[],o=0;i*n>o;o++)r.push(0);var o,a;for(o=0;3>o;o++)for(a=0;3>a;a++)r[o+n*a]=this.elements[o+3*a];r[3]=1,r[9]=0,r[15]=0,r[4]=0,r[10]=1,r[16]=0,r[5]=0,r[11]=0,r[17]=1;var s,u,c=3,l=c,h=n;do{if(o=l-c,0===r[o+n*o])for(a=o+1;l>a;a++)if(0!==r[o+n*a]){s=h;do u=h-s,r[u+n*o]+=r[u+n*a];while(--s);break}if(0!==r[o+n*o])for(a=o+1;l>a;a++){var p=r[o+n*a]/r[o+n*o];s=h;do u=h-s,r[u+n*a]=o>=u?0:r[u+n*a]-r[u+n*o]*p;while(--s)}}while(--c);o=2;do{a=o-1;do{var p=r[o+n*a]/r[o+n*o];s=n;do u=n-s,r[u+n*a]=r[u+n*a]-r[u+n*o]*p;while(--s)}while(a--)}while(--o);o=2;do{var p=1/r[o+n*o];s=n;do u=n-s,r[u+n*o]=r[u+n*o]*p;while(--s)}while(o--);o=2;do{a=2;do{if(u=r[i+a+n*o],isNaN(u)||1/0===u)throw"Could not reverse! A=["+(""+this)+"]";e.e(o,a,u)}while(a--)}while(o--);return e},t.Vec3=function(t,e,i){this.x=t||0,this.y=e||0,this.z=i||0},t.Vec3.prototype.cross=function(e,i){var n=e.x,r=e.y,o=e.z,a=this.x,s=this.y,u=this.z;return i=i||new t.Vec3,i.x=s*o-u*r,i.y=u*n-a*o,i.z=a*r-s*n,i},t.Vec3.prototype.set=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},t.Vec3.prototype.vadd=function(e,i){return i?(i.x=e.x+this.x,i.y=e.y+this.y,i.z=e.z+this.z,void 0):new t.Vec3(this.x+e.x,this.y+e.y,this.z+e.z)},t.Vec3.prototype.vsub=function(e,i){return i?(i.x=this.x-e.x,i.y=this.y-e.y,i.z=this.z-e.z,void 0):new t.Vec3(this.x-e.x,this.y-e.y,this.z-e.z)},t.Vec3.prototype.crossmat=function(){return new t.Mat3([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},t.Vec3.prototype.normalize=function(){var t=this.x,e=this.y,i=this.z,n=Math.sqrt(t*t+e*e+i*i);if(n>0){var r=1/n;this.x*=r,this.y*=r,this.z*=r}else this.x=0,this.y=0,this.z=0;return n},t.Vec3.prototype.unit=function(e){e=e||new t.Vec3;var i=this.x,n=this.y,r=this.z,o=Math.sqrt(i*i+n*n+r*r);return o>0?(o=1/o,e.x=i*o,e.y=n*o,e.z=r*o):(e.x=1,e.y=0,e.z=0),e},t.Vec3.prototype.norm=function(){var t=this.x,e=this.y,i=this.z;return Math.sqrt(t*t+e*e+i*i)},t.Vec3.prototype.norm2=function(){return this.dot(this)},t.Vec3.prototype.distanceTo=function(t){var e=this.x,i=this.y,n=this.z,r=t.x,o=t.y,a=t.z;return Math.sqrt((r-e)*(r-e)+(o-i)*(o-i)+(a-n)*(a-n))},t.Vec3.prototype.mult=function(e,i){i=i||new t.Vec3;var n=this.x,r=this.y,o=this.z;return i.x=e*n,i.y=e*r,i.z=e*o,i},t.Vec3.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},t.Vec3.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},t.Vec3.prototype.negate=function(e){return e=e||new t.Vec3,e.x=-this.x,e.y=-this.y,e.z=-this.z,e};var e=new t.Vec3,i=new t.Vec3;t.Vec3.prototype.tangents=function(t,n){var r=this.norm();if(r>0){var o=e,a=1/r;o.set(this.x*a,this.y*a,this.z*a);var s=i;.9>Math.abs(o.x)?(s.set(1,0,0),o.cross(s,t)):(s.set(0,1,0),o.cross(s,t)),o.cross(t,n)}else t.set(1,0,0).normalize(),n.set(0,1,0).normalize()},t.Vec3.prototype.toString=function(){return this.x+","+this.y+","+this.z},t.Vec3.prototype.copy=function(e){return e=e||new t.Vec3,e.x=this.x,e.y=this.y,e.z=this.z,e},t.Vec3.prototype.lerp=function(t,e,i){var n=this.x,r=this.y,o=this.z;i.x=n+(t.x-n)*e,i.y=r+(t.y-r)*e,i.z=o+(t.z-o)*e},t.Vec3.prototype.almostEquals=function(t,e){return void 0===e&&(e=1e-6),Math.abs(this.x-t.x)>e||Math.abs(this.y-t.y)>e||Math.abs(this.z-t.z)>e?!1:!0},t.Vec3.prototype.almostZero=function(t){return void 0===t&&(t=1e-6),Math.abs(this.x)>t||Math.abs(this.y)>t||Math.abs(this.z)>t?!1:!0},t.Quaternion=function(t,e,i,n){this.x=void 0!==t?t:0,this.y=void 0!==e?e:0,this.z=void 0!==i?i:0,this.w=void 0!==n?n:1},t.Quaternion.prototype.set=function(t,e,i,n){this.x=t,this.y=e,this.z=i,this.w=n},t.Quaternion.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},t.Quaternion.prototype.setFromAxisAngle=function(t,e){var i=Math.sin(.5*e);this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this.w=Math.cos(.5*e)},t.Quaternion.prototype.toAxisAngle=function(e){e=e||new t.Vec3,this.normalize();var i=2*Math.acos(this.w),n=Math.sqrt(1-this.w*this.w);return.001>n?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/n,e.y=this.y/n,e.z=this.z/n),[e,i]},t.Quaternion.prototype.setFromVectors=function(t,e){var i=t.cross(e);this.x=i.x,this.y=i.y,this.z=i.z,this.w=Math.sqrt(Math.pow(t.norm(),2)*Math.pow(e.norm(),2))+t.dot(e),this.normalize()};var n=new t.Vec3,r=new t.Vec3,o=new t.Vec3;t.Quaternion.prototype.mult=function(e,i){i=i||new t.Quaternion;var a=this.w,s=n,u=r,c=o;return s.set(this.x,this.y,this.z),u.set(e.x,e.y,e.z),i.w=a*e.w-s.dot(u),s.cross(u,c),i.x=a*u.x+e.w*s.x+c.x,i.y=a*u.y+e.w*s.y+c.y,i.z=a*u.z+e.w*s.z+c.z,i},t.Quaternion.prototype.inverse=function(e){var i=this.x,n=this.y,r=this.z,o=this.w;e=e||new t.Quaternion,this.conjugate(e);var a=1/(i*i+n*n+r*r+o*o);return e.x*=a,e.y*=a,e.z*=a,e.w*=a,e},t.Quaternion.prototype.conjugate=function(e){return e=e||new t.Quaternion,e.x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},t.Quaternion.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t)},t.Quaternion.prototype.normalizeFast=function(){var t=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=t,this.y*=t,this.z*=t,this.w*=t)},t.Quaternion.prototype.vmult=function(e,i){if(i=i||new t.Vec3,0===this.w)i.x=e.x,i.y=e.y,i.z=e.z;else{var n=e.x,r=e.y,o=e.z,a=this.x,s=this.y,u=this.z,c=this.w,l=c*n+s*o-u*r,h=c*r+u*n-a*o,p=c*o+a*r-s*n,d=-a*n-s*r-u*o;i.x=l*c+d*-a+h*-u-p*-s,i.y=h*c+d*-s+p*-a-l*-u,i.z=p*c+d*-u+l*-s-h*-a}return i},t.Quaternion.prototype.copy=function(t){t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w},t.Quaternion.prototype.toEuler=function(t,e){e=e||"YZX";var i,n,r,o=this.x,a=this.y,s=this.z,u=this.w;switch(e){case"YZX":var c=o*a+s*u;if(c>.499&&(i=2*Math.atan2(o,u),n=Math.PI/2,r=0),-.499>c&&(i=-2*Math.atan2(o,u),n=-Math.PI/2,r=0),isNaN(i)){var l=o*o,h=a*a,p=s*s;i=Math.atan2(2*a*u-2*o*s,1-2*h-2*p),n=Math.asin(2*c),r=Math.atan2(2*o*u-2*a*s,1-2*l-2*p)}break;default:throw Error("Euler order "+e+" not supported yet.")}t.y=i,t.z=n,t.x=r},t.EventTarget=function(){var t={};this.addEventListener=function(e,i){void 0===t[e]&&(t[e]=[]),-1===t[e].indexOf(i)&&t[e].push(i)},this.dispatchEvent=function(e){for(var i in t[e.type])t[e.type][i](e)},this.removeEventListener=function(e,i){var n=t[e].indexOf(i);-1!==n&&t[e].splice(n,1)}},t.ObjectPool=function(){this.objects=[],this.type=Object},t.ObjectPool.prototype.release=function(){for(var t=arguments.length,e=0;e!==t;e++)this.objects.push(arguments[e])},t.ObjectPool.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},t.ObjectPool.prototype.constructObject=function(){throw Error("constructObject() not implemented in this ObjectPool subclass yet!")},t.Vec3Pool=function(){t.ObjectPool.call(this),this.type=t.Vec3},t.Vec3Pool.prototype=new t.ObjectPool,t.Vec3Pool.prototype.constructObject=function(){return new t.Vec3},t.Shape=function(){this.type=0,this.aabbmin=new t.Vec3,this.aabbmax=new t.Vec3,this.boundingSphereRadius=0,this.boundingSphereRadiusNeedsUpdate=!0},t.Shape.prototype.constructor=t.Shape,t.Shape.prototype.computeBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},t.Shape.prototype.getBoundingSphereRadius=function(){return this.boundingSphereRadiusNeedsUpdate&&this.computeBoundingSphereRadius(),this.boundingSphereRadius},t.Shape.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},t.Shape.prototype.calculateLocalInertia=function(){throw"calculateLocalInertia() not implemented for shape type "+this.type};var a=new t.Vec3,s=new t.Vec3;t.Shape.prototype.calculateTransformedInertia=function(e,i,n){n=n||new t.Vec3;var r=a,o=s;return this.calculateLocalInertia(e,r),i.vmult(r,o),n.x=Math.abs(o.x),n.y=Math.abs(o.y),n.z=Math.abs(o.z),n},t.Shape.calculateLocalAABB=function(){throw Error(".calculateLocalAABB is not implemented for this Shape yet!")},t.Shape.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16},t.Body=function(e){t.EventTarget.apply(this),this.type=e,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new t.Vec3,this.collisionFilterGroup=1,this.collisionFilterMask=1},t.Body.DYNAMIC=1,t.Body.STATIC=2,t.Body.KINEMATIC=4,t.Particle=function(e,i){if("number"!=typeof e)throw Error("Argument 1 (mass) must be a number.");if(i!==void 0&&!(i instanceof t.Material))throw Error("Argument 3 (material) must be an instance of CANNON.Material.");t.Body.call(this,"particle"),this.position=new t.Vec3,this.initPosition=new t.Vec3,this.velocity=new t.Vec3,this.initVelocity=new t.Vec3,this.force=new t.Vec3,this.mass=e,this.invMass=e>0?1/e:0,this.material=i,this.linearDamping=.01,this.motionstate=0>=e?t.Body.STATIC:t.Body.DYNAMIC,this.allowSleep=!0,this.sleepState=0,this.sleepSpeedLimit=.1,this.sleepTimeLimit=1,this.timeLastSleepy=0},t.Particle.prototype=new t.Body,t.Particle.prototype.constructor=t.Particle,t.Particle.prototype.isAwake=function(){return 0===this.sleepState},t.Particle.prototype.isSleepy=function(){return 1===this.sleepState},t.Particle.prototype.isSleeping=function(){return 2===this.sleepState},t.Particle.prototype.wakeUp=function(){var t=this.sleepState;this.sleepState=0,2===t&&this.dispatchEvent({type:"wakeup"})},t.Particle.prototype.sleep=function(){this.sleepState=2},t.Particle.prototype.sleepTick=function(t){if(this.allowSleep){var e=this.sleepState,i=this.velocity.norm2(),n=Math.pow(this.sleepSpeedLimit,2);0===e&&n>i?(this.sleepState=1,this.timeLastSleepy=t,this.dispatchEvent({type:"sleepy"})):1===e&&i>n?this.wakeUp():1===e&&t-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleepState=2,this.dispatchEvent({type:"sleep"}))}},t.RigidBody=function(e,i,n){if("number"!=typeof e)throw Error("Argument 1 (mass) must be a number.");if(n!==void 0&&!(n instanceof t.Material))throw Error("Argument 3 (material) must be an instance of CANNON.Material.");t.Particle.call(this,e,n),this.tau=new t.Vec3,this.quaternion=new t.Quaternion,this.initQuaternion=new t.Quaternion,this.angularVelocity=new t.Vec3,this.initAngularVelocity=new t.Vec3,this.shape=i,this.inertia=new t.Vec3,i.calculateLocalInertia(e,this.inertia),this.inertiaWorld=new t.Vec3,this.inertia.copy(this.inertiaWorld),this.inertiaWorldAutoUpdate=!1,this.invInertia=new t.Vec3(this.inertia.x>0?1/this.inertia.x:0,this.inertia.y>0?1/this.inertia.y:0,this.inertia.z>0?1/this.inertia.z:0),this.invInertiaWorld=new t.Vec3,this.invInertia.copy(this.invInertiaWorld),this.invInertiaWorldAutoUpdate=!1,this.angularDamping=.01,this.aabbmin=new t.Vec3,this.aabbmax=new t.Vec3,this.aabbNeedsUpdate=!0,this.wlambda=new t.Vec3},t.RigidBody.prototype=new t.Particle(0),t.RigidBody.prototype.constructor=t.RigidBody,t.RigidBody.prototype.computeAABB=function(){this.shape.calculateWorldAABB(this.position,this.quaternion,this.aabbmin,this.aabbmax),this.aabbNeedsUpdate=!1};var u=new t.Vec3,c=new t.Vec3;t.RigidBody.prototype.applyForce=function(t,e){var i=u;e.vsub(this.position,i);var n=c;i.cross(t,n),this.force.vadd(t,this.force),this.tau.vadd(n,this.tau)};var l=new t.Vec3,h=new t.Vec3,p=new t.Vec3;t.RigidBody.prototype.applyImpulse=function(t,e){var i=l;e.vsub(this.position,i);var n=h;t.copy(n),n.mult(this.invMass,n),this.velocity.vadd(n,this.velocity);var r=p;i.cross(t,r),r.x*=this.invInertia.x,r.y*=this.invInertia.y,r.z*=this.invInertia.z,this.angularVelocity.vadd(r,this.angularVelocity)},t.Sphere=function(e){t.Shape.call(this),this.radius=void 0!==e?Number(e):1,this.type=t.Shape.types.SPHERE},t.Sphere.prototype=new t.Shape,t.Sphere.prototype.constructor=t.Sphere,t.Sphere.prototype.calculateLocalInertia=function(e,i){i=i||new t.Vec3;var n=2*e*this.radius*this.radius/5;return i.x=n,i.y=n,i.z=n,i},t.Sphere.prototype.volume=function(){return 4*Math.PI*this.radius/3},t.Sphere.prototype.computeBoundingSphereRadius=function(){this.boundingSphereRadiusNeedsUpdate=!1,this.boundingSphereRadius=this.radius},t.Sphere.prototype.calculateWorldAABB=function(t,e,i,n){for(var r=this.radius,o=["x","y","z"],a=0;o.length>a;a++){var s=o[a];i[s]=t[s]-r,n[s]=t[s]+r}},t.SPHSystem=function(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]},t.SPHSystem.prototype.add=function(t){this.particles.push(t),this.neighbors.length<this.particles.length&&this.neighbors.push([])},t.SPHSystem.prototype.remove=function(t){var e=this.particles.indexOf(t);-1!==e&&(this.particles.splice(e,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var d=new t.Vec3;t.SPHSystem.prototype.getNeighbors=function(t,e){for(var i=this.particles.length,n=t.id,r=this.smoothingRadius*this.smoothingRadius,o=d,a=0;a!==i;a++){var s=this.particles[a];s.position.vsub(t.position,o),n!==s.id&&r>o.norm2()&&e.push(s)}};var v=new t.Vec3,f=new t.Vec3,y=new t.Vec3,m=new t.Vec3,w=new t.Vec3,g=new t.Vec3;t.SPHSystem.prototype.update=function(){for(var t=this.particles.length,e=v,i=this.speedOfSound,n=this.eps,r=0;r!==t;r++){var o=this.particles[r],a=this.neighbors[r];
a.length=0,this.getNeighbors(o,a),a.push(this.particles[r]);for(var s=a.length,u=0,c=0;c!==s;c++){o.position.vsub(a[c].position,e);var l=e.norm(),h=this.w(l);u+=a[c].mass*h}this.densities[r]=u,this.pressures[r]=i*i*(this.densities[r]-this.density)}for(var p=f,d=y,b=m,x=w,V=g,r=0;r!==t;r++){var E=this.particles[r];p.set(0,0,0),d.set(0,0,0);for(var z,S,a=this.neighbors[r],s=a.length,c=0;c!==s;c++){var N=a[c];E.position.vsub(N.position,x);var M=x.norm();z=-N.mass*(this.pressures[r]/(this.densities[r]*this.densities[r]+n)+this.pressures[c]/(this.densities[c]*this.densities[c]+n)),this.gradw(x,b),b.mult(z,b),p.vadd(b,p),N.velocity.vsub(E.velocity,V),V.mult(1/(1e-4+this.densities[r]*this.densities[c])*this.viscosity*N.mass,V),S=this.nablaw(M),V.mult(S,V),d.vadd(V,d)}d.mult(E.mass,d),p.mult(E.mass,p),E.force.vadd(d,E.force),E.force.vadd(p,E.force)}},t.SPHSystem.prototype.w=function(t){var e=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(e,9))*Math.pow(e*e-t*t,3)},t.SPHSystem.prototype.gradw=function(t,e){var i=t.norm(),n=this.smoothingRadius;t.mult(945/(32*Math.PI*Math.pow(n,9))*Math.pow(n*n-i*i,2),e)},t.SPHSystem.prototype.nablaw=function(t){var e=this.smoothingRadius,i=945/(32*Math.PI*Math.pow(e,9))*(e*e-t*t)*(7*t*t-3*e*e);return i},t.Box=function(e){t.Shape.call(this),this.halfExtents=e,this.type=t.Shape.types.BOX,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation()},t.Box.prototype=new t.Shape,t.Box.prototype.constructor=t.Box,t.Box.prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x,i=this.halfExtents.y,n=this.halfExtents.z,r=t.Vec3,o=new t.ConvexPolyhedron([new r(-e,-i,-n),new r(e,-i,-n),new r(e,i,-n),new r(-e,i,-n),new r(-e,-i,n),new r(e,-i,n),new r(e,i,n),new r(-e,i,n)],[[3,2,1,0],[4,5,6,7],[5,4,1,0],[2,3,6,7],[0,4,7,3],[1,2,5,6]],[new r(0,0,-1),new r(0,0,1),new r(0,-1,0),new r(0,1,0),new r(-1,0,0),new r(1,0,0)]);this.convexPolyhedronRepresentation=o},t.Box.prototype.calculateLocalInertia=function(e,i){i=i||new t.Vec3;var n=this.halfExtents;return i.x=1/12*e*(2*2*n.y*n.y+2*2*n.z*n.z),i.y=1/12*e*(2*2*n.x*n.x+2*2*n.z*n.z),i.z=1/12*e*(2*2*n.y*n.y+2*2*n.x*n.x),i},t.Box.prototype.getSideNormals=function(t,e){var i=t,n=this.halfExtents;if(i[0].set(n.x,0,0),i[1].set(0,n.y,0),i[2].set(0,0,n.z),i[3].set(-n.x,0,0),i[4].set(0,-n.y,0),i[5].set(0,0,-n.z),void 0!==e)for(var r=0;r!==i.length;r++)e.vmult(i[r],i[r]);return i},t.Box.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},t.Box.prototype.computeBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm(),this.boundingSphereRadiusNeedsUpdate=!1};var b=new t.Vec3;new t.Vec3,t.Box.prototype.forEachWorldCorner=function(t,e,i){for(var n=this.halfExtents,r=[[n.x,n.y,n.z],[-n.x,n.y,n.z],[-n.x,-n.y,n.z],[-n.x,-n.y,-n.z],[n.x,-n.y,-n.z],[n.x,n.y,-n.z],[-n.x,n.y,-n.z],[n.x,-n.y,n.z]],o=0;r.length>o;o++)b.set(r[o][0],r[o][1],r[o][2]),e.vmult(b,b),t.vadd(b,b),i(b.x,b.y,b.z)},t.Box.prototype.calculateWorldAABB=function(t,e,i,n){i.set(1/0,1/0,1/0),n.set(-1/0,-1/0,-1/0),this.forEachWorldCorner(t,e,function(t,e,r){t>n.x&&(n.x=t),e>n.y&&(n.y=e),r>n.z&&(n.z=r),i.x>t&&(i.x=t),i.y>e&&(i.y=e),i.z>r&&(i.z=r)})},t.Plane=function(){t.Shape.call(this),this.type=t.Shape.types.PLANE,this.worldNormal=new t.Vec3,this.worldNormalNeedsUpdate=!0},t.Plane.prototype=new t.Shape,t.Plane.prototype.constructor=t.Plane,t.Plane.prototype.computeWorldNormal=function(t){var e=this.worldNormal;e.set(0,0,1),t.vmult(e,e),this.worldNormalNeedsUpdate=!1},t.Plane.prototype.calculateLocalInertia=function(e,i){return i=i||new t.Vec3},t.Plane.prototype.volume=function(){return 1/0};var x=new t.Vec3;t.Plane.prototype.calculateWorldAABB=function(t,e,i,n){x.set(0,0,1),e.vmult(x,x),i.set(-1/0,-1/0,-1/0),n.set(1/0,1/0,1/0),1===x.x&&(n.x=t.x),1===x.y&&(n.y=t.y),1===x.z&&(n.z=t.z),-1===x.x&&(i.x=t.x),-1===x.y&&(i.y=t.y),-1===x.z&&(i.z=t.z)},t.Compound=function(){t.Shape.call(this),this.type=t.Shape.types.COMPOUND,this.childShapes=[],this.childOffsets=[],this.childOrientations=[]},t.Compound.prototype=new t.Shape,t.Compound.prototype.constructor=t.Compound,t.Compound.prototype.addChild=function(e,i,n){i=i||new t.Vec3,n=n||new t.Quaternion,this.childShapes.push(e),this.childOffsets.push(i),this.childOrientations.push(n)},t.Compound.prototype.volume=function(){for(var t=0,e=this.childShapes.length,i=0;i!==e;i++)t+=this.childShapes[i].volume();return t};var V=new t.Vec3,E=new t.Vec3;t.Compound.prototype.calculateLocalInertia=function(e,i){i=i||new t.Vec3;for(var n=this.volume(),r=E,o=0,a=this.childShapes.length;o!==a;o++){var s=this.childShapes[o],u=this.childOffsets[o];this.childOrientations[o];var c=s.volume()/n*e;s.calculateLocalInertia(c,r),i.vadd(r,i);var l=V;l.set(c*u.x*u.x,c*u.y*u.y,c*u.z*u.z),i.vadd(l,i)}return i},t.Compound.prototype.computeBoundingSphereRadius=function(){for(var t=0,e=0;this.childShapes.length>e;e++){var i=this.childShapes[e];i.boundingSphereRadiusNeedsUpdate&&i.computeBoundingSphereRadius();var n=this.childOffsets[e].norm()+i.boundingSphereRadius;n>t&&(t=n)}this.boundingSphereRadius=t,this.boundingSphereRadiusNeedsUpdate=!1};var z=new t.Vec3,S=new t.Vec3,N=new t.Vec3,M=new t.Quaternion;t.Compound.prototype.calculateWorldAABB=function(t,e,i,n){var r=this.childShapes.length;i.set(1/0,1/0,1/0),n.set(-1/0,-1/0,-1/0);for(var o=0;o!==r;o++)this.childOffsets[o].copy(N),e.vmult(N,N),t.vadd(N,N),e.mult(this.childOrientations[o],M),this.childShapes[o].calculateWorldAABB(N,M,S,z),S.x<i.x&&(i.x=S.x),S.y<i.y&&(i.y=S.y),S.z<i.z&&(i.z=S.z),z.x>n.x&&(n.x=z.x),z.y>n.y&&(n.y=z.y),z.z>n.z&&(n.z=z.z)},t.ConvexPolyhedron=function(e,i){function n(t,e,i,n){e.vsub(t,c),i.vsub(e,u),u.cross(c,n),n.isZero()||n.normalize()}function r(t,e,i,n,r){for(var o=t.vertices.length,a=null,s=null,u=t.vertices,c=0;o>c;c++){u[c].copy(V),n.vmult(V,V),V.vadd(i,V);var l=V.dot(e);(null===a||l>a)&&(a=l),(null===s||s>l)&&(s=l)}if(s>a){var h=s;s=a,a=h}r[0]=a,r[1]=s}function o(t,e){var i=s.faces[t],r=s.vertices[i[0]],o=s.vertices[i[1]],a=s.vertices[i[2]];return n(r,o,a,e)}function a(t){var e=s.faces[t],i=s.faceNormals[t],n=s.vertices[e[0]],r=-i.dot(n);return r}var s=this;t.Shape.call(this),this.type=t.Shape.types.CONVEXPOLYHEDRON;var u=new t.Vec3,c=new t.Vec3;this.vertices=e||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=i||[],this.faceNormals=[];for(var l=0;this.faces.length>l;l++){for(var h=0;this.faces[l].length>h;h++)if(!this.vertices[this.faces[l][h]])throw Error("Vertex "+this.faces[l][h]+" not found!");var p=new t.Vec3;o(l,p),p.negate(p),this.faceNormals.push(p);var d=this.vertices[this.faces[l][0]];if(0>p.dot(d)){console.warn("Face normal "+l+" ("+(""+p)+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var h=0;this.faces[l].length>h;h++)console.warn("Vertex "+this.faces[l][h]+": ("+(""+this.vertices[i[l][h]])+")")}}this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[];for(var v=this.vertices.length,f=0;v>f;f++){var y=this.vertices[f];if(!(y instanceof t.Vec3))throw"Argument 1 must be instance of CANNON.Vec3";this.uniqueEdges.push(y)}for(var l=0;this.faces.length>l;l++)for(var m=this.faces[l].length,w=m,h=0;w>h;h++){var g=(h+1)%m,b=new t.Vec3;this.vertices[this.faces[l][h]].vsub(this.vertices[this.faces[l][g]],b),b.normalize();for(var x=!1,y=0;this.uniqueEdges.length>y;y++)if(this.uniqueEdges[y].almostEquals(b)||this.uniqueEdges[y].almostEquals(b)){x=!0;break}x||this.uniqueEdges.push(b),b&&(b.face1=l)}var V=new t.Vec3;this.testSepAxis=function(t,e,i,n,o,a){var s=[],u=[],c=this;r(c,t,i,n,s),r(e,t,o,a,u);var l=s[0],h=s[1],p=u[0],d=u[1];if(d>l||h>p)return!1;var v=l-d,f=p-h,y=f>v?v:f;return y};var E=new t.Vec3,z=new t.Vec3,S=new t.Vec3,N=new t.Vec3,M=new t.Vec3,j=new t.Vec3;this.findSeparatingAxis=function(t,e,i,n,r,o){for(var a=1/0,s=this,u=0,c=s.faces.length,l=0;c>l;l++){s.faceNormals[l].copy(E),i.vmult(E,E);var h=s.testSepAxis(E,t,e,i,n,r);if(h===!1)return!1;a>h&&(a=h,E.copy(o))}for(var p=t.faces.length,l=0;p>l;l++){t.faceNormals[l].copy(z),r.vmult(z,z),u++;var h=s.testSepAxis(z,t,e,i,n,r);if(h===!1)return!1;a>h&&(a=h,z.copy(o))}for(var d=0,v=0;s.uniqueEdges.length>v;v++){s.uniqueEdges[v].copy(N),i.vmult(N,N);for(var f=0;t.uniqueEdges.length>f;f++)if(t.uniqueEdges[f].copy(M),r.vmult(M,M),N.cross(M,j),d++,!j.almostZero()){j.normalize();var y=s.testSepAxis(j,t,e,i,n,r);if(y===!1)return!1;a>y&&(a=y,j.copy(o))}}return n.vsub(e,S),S.dot(o)>0&&o.negate(o),!0};var P=new t.Vec3;this.clipAgainstHull=function(e,i,n,r,o,a,s,u,c){if(!(e instanceof t.Vec3))throw Error("posA must be Vec3");if(!(i instanceof t.Quaternion))throw Error("quatA must be Quaternion");for(var l=-1,h=-1/0,p=0;n.faces.length>p;p++){n.faceNormals[p].copy(P),o.vmult(P,P);var d=P.dot(a);d>h&&(h=d,l=p)}for(var v=[],f=n.faces[l],y=f.length,m=0;y>m;m++){var w=n.vertices[f[m]],g=new t.Vec3;w.copy(g),o.vmult(g,g),r.vadd(g,g),v.push(g)}l>=0&&this.clipFaceAgainstHull(a,e,i,v,s,u,c)};var q=new t.Vec3,A=new t.Vec3,I=new t.Vec3,B=new t.Vec3,C=new t.Vec3,O=new t.Vec3,R=new t.Vec3,T=new t.Vec3;this.clipFaceAgainstHull=function(e,i,n,r,o,s,u){if(!(e instanceof t.Vec3))throw Error("sep normal must be vector");if(!(r instanceof Array))throw Error("world verts must be array");o=Number(o),s=Number(s);for(var c=this,l=[],h=r,p=l,d=-1,v=1/0,f=0;c.faces.length>f;f++){c.faceNormals[f].copy(q),n.vmult(q,q);var y=q.dot(e);v>y&&(v=y,d=f)}if(0>d)return console.log("--- did not find any closest face... ---"),void 0;var m=c.faces[d];m.connectedFaces=[];for(var w=0;c.faces.length>w;w++)for(var g=0;c.faces[w].length>g;g++)-1!==m.indexOf(c.faces[w][g])&&w!==d&&-1===m.connectedFaces.indexOf(w)&&m.connectedFaces.push(w);h.length;for(var b=m.length,x=0;b>x;x++){var V=c.vertices[m[x]],E=c.vertices[m[(x+1)%b]];V.vsub(E,A),A.copy(I),n.vmult(I,I),i.vadd(I,I),this.faceNormals[d].copy(B),n.vmult(B,B),i.vadd(B,B),I.cross(B,C),C.negate(C),V.copy(O),n.vmult(O,O),i.vadd(O,O);var z,S=(-O.dot(C),m.connectedFaces[x]);this.faceNormals[S].copy(R);var N=a(S);R.copy(T),n.vmult(T,T);var z=N-T.dot(i);for(this.clipFaceAgainstPlane(h,p,T,z);h.length;)h.shift();for(;p.length;)h.push(p.shift())}this.faceNormals[d].copy(R);var N=a(d);R.copy(T),n.vmult(T,T);for(var z=N-T.dot(i),w=0;h.length>w;w++){var M=T.dot(h[w])+z;if(o>=M&&(console.log("clamped: depth="+M+" to minDist="+(o+"")),M=o),s>=M){var j=h[w];if(0>=M){var P={point:j,normal:T,depth:M};u.push(P)}}}},this.clipFaceAgainstPlane=function(e,i,n,r){if(!(n instanceof t.Vec3))throw Error("planeNormal must be Vec3, "+n+" given");if(!(e instanceof Array))throw Error("invertices must be Array, "+e+" given");if(!(i instanceof Array))throw Error("outvertices must be Array, "+i+" given");var o,a,s=e.length;if(2>s)return i;var u=e[e.length-1],c=e[0];o=n.dot(u)+r;for(var l=0;s>l;l++){if(c=e[l],a=n.dot(c)+r,0>o)if(0>a){var h=new t.Vec3;c.copy(h),i.push(h)}else{var h=new t.Vec3;u.lerp(c,o/(o-a),h),i.push(h)}else if(0>a){var h=new t.Vec3;u.lerp(c,o/(o-a),h),i.push(h),i.push(c)}u=c,o=a}return i};var s=this;this.calculateLocalInertia=function(t,e){s.computeAABB();var i=this.aabbmax.x-this.aabbmin.x,n=this.aabbmax.y-this.aabbmin.y,r=this.aabbmax.z-this.aabbmin.z;e.x=1/12*t*(2*2*n*n+2*2*r*r),e.y=1/12*t*(2*2*i*i+2*2*r*r),e.z=1/12*t*(2*2*n*n+2*2*i*i)},new t.Vec3,this.computeAABB=function(){var t=this.vertices.length,e=this.aabbmin,i=this.aabbmax,n=this.vertices;e.set(1/0,1/0,1/0),i.set(-1/0,-1/0,-1/0);for(var r=0;t>r;r++){var o=n[r];o.x<e.x?e.x=o.x:o.x>i.x&&(i.x=o.x),o.y<e.y?e.y=o.y:o.y>i.y&&(i.y=o.y),o.z<e.z?e.z=o.z:o.z>i.z&&(i.z=o.z)}}},t.ConvexPolyhedron.prototype=new t.Shape,t.ConvexPolyhedron.prototype.constructor=t.ConvexPolyhedron,t.ConvexPolyhedron.prototype.computeWorldVertices=function(e,i){for(var n=this.vertices.length;n>this.worldVertices.length;)this.worldVertices.push(new t.Vec3);for(var r=this.vertices,o=this.worldVertices,a=0;a!==n;a++)i.vmult(r[a],o[a]),e.vadd(o[a],o[a]);this.worldVerticesNeedsUpdate=!1},t.ConvexPolyhedron.prototype.computeWorldFaceNormals=function(e){for(var i=this.faceNormals.length;i>this.worldFaceNormals.length;)this.worldFaceNormals.push(new t.Vec3);for(var n=this.faceNormals,r=this.worldFaceNormals,o=0;o!==i;o++)e.vmult(n[o],r[o]);this.worldFaceNormalsNeedsUpdate=!1},t.ConvexPolyhedron.prototype.computeBoundingSphereRadius=function(){for(var t=0,e=this.vertices,i=0,n=e.length;i!==n;i++){var r=e[i].norm2();r>t&&(t=r)}this.boundingSphereRadius=Math.sqrt(t),this.boundingSphereRadiusNeedsUpdate=!1};var j=new t.Vec3;t.ConvexPolyhedron.prototype.calculateWorldAABB=function(t,e,i,n){for(var r,o,a,s,u,c,l=this.vertices.length,h=this.vertices,p=0;l>p;p++){h[p].copy(j),e.vmult(j,j),t.vadd(j,j);var d=j;r>d.x||void 0===r?r=d.x:(d.x>s||void 0===s)&&(s=d.x),o>d.y||void 0===o?o=d.y:(d.y>u||void 0===u)&&(u=d.y),a>d.z||void 0===a?a=d.z:(d.z>c||void 0===c)&&(c=d.z)}i.set(r,o,a),n.set(s,u,c)},t.ConvexPolyhedron.prototype.volume=function(){return this.boundingSphereRadiusNeedsUpdate&&this.computeBoundingSphereRadius(),4*Math.PI*this.boundingSphereRadius/3},t.ConvexPolyhedron.prototype.getAveragePointLocal=function(e){e=e||new t.Vec3;for(var i=this.vertices.length,n=this.vertices,r=0;i>r;r++)e.vadd(n[r],e);return e.mult(1/i,e),e},t.ConvexPolyhedron.prototype.transformAllPoints=function(t,e){var i=this.vertices.length,n=this.vertices;if(e){for(var r=0;i>r;r++){var o=n[r];e.vmult(o,o)}for(var r=0;this.faceNormals.length>r;r++){var o=this.faceNormals[r];e.vmult(o,o)}}if(t)for(var r=0;i>r;r++){var o=n[r];o.vadd(t,o)}};var P=new t.Vec3,q=new t.Vec3,A=new t.Vec3;t.ConvexPolyhedron.prototype.pointIsInside=function(t){var e=this.vertices.length,i=this.vertices,n=this.faces,r=this.faceNormals,o=null,a=this.faces.length,s=P;this.getAveragePointLocal(s);for(var u=0;a>u;u++){this.faces[u].length;var e=r[u],c=i[n[u][0]],l=q;t.vsub(c,l);var h=e.dot(l),p=A;s.vsub(c,p);var d=e.dot(p);if(0>h&&d>0||h>0&&0>d)return!1}return o?1:-1},t.Cylinder=function(e,i,n,r){var o=r,a=[],s=[],u=[],c=[],l=[],h=Math.cos,p=Math.sin;a.push(new t.Vec3(i*h(0),i*p(0),.5*-n)),c.push(0),a.push(new t.Vec3(e*h(0),e*p(0),.5*n)),l.push(1);for(var d=0;o>d;d++){var v=2*Math.PI/o*(d+1),f=2*Math.PI/o*(d+.5);o-1>d?(a.push(new t.Vec3(i*h(v),i*p(v),.5*-n)),c.push(2*d+2),a.push(new t.Vec3(e*h(v),e*p(v),.5*n)),l.push(2*d+3),s.push(new t.Vec3(h(f),p(f),0)),u.push([2*d+2,2*d+3,2*d+1,2*d])):(u.push([0,1,2*d+1,2*d]),s.push(new t.Vec3(h(f),p(f),0)))}u.push(l),s.push(new t.Vec3(0,0,1));for(var y=[],d=0;c.length>d;d++)y.push(c[c.length-d-1]);u.push(y),s.push(new t.Vec3(0,0,-1)),this.type=t.Shape.types.CONVEXPOLYHEDRON,t.ConvexPolyhedron.call(this,a,u,s)},t.Cylinder.prototype=new t.ConvexPolyhedron,t.Ray=function(e,i){function n(t,e,i){return i.vsub(t,V),p=V.dot(e),e.mult(p,E),E.vadd(t,E),d=i.distanceTo(E)}function r(t,e,i,n){return n.vsub(e,V),i.vsub(e,z),t.vsub(e,S),v=V.dot(V),f=V.dot(z),y=V.dot(S),m=z.dot(z),w=z.dot(S),g=1/(v*m-f*f),b=(m*y-f*w)*g,x=(v*w-f*y)*g,b>=0&&x>=0&&1>b+x}this.origin=e||new t.Vec3,this.direction=i||new t.Vec3;var o=1e-4;this.setPrecision=function(t){o=t};var a=new t.Vec3,s=new t.Vec3,u=new t.Vec3;new t.Vec3,new t.Vec3;var c=new t.Vec3,l=new t.Vec3,h=new t.Vec3;this.intersectBody=function(e){return e.shape instanceof t.ConvexPolyhedron?this.intersectShape(e.shape,e.quaternion,e.position,e):e.shape instanceof t.Box?this.intersectShape(e.shape.convexPolyhedronRepresentation,e.quaternion,e.position,e):(console.warn("Ray intersection is this far only implemented for ConvexPolyhedron and Box shapes."),void 0)},this.intersectShape=function(e,i,p,d){var v,f=[];if(e instanceof t.ConvexPolyhedron){var y=n(this.origin,this.direction,p);if(y>e.getBoundingSphereRadius())return f;for(var m,w,g=e.faces,b=e.vertices,x=e.faceNormals,V=0;g.length>V;V++){var E=g[V],z=x[V],S=i,N=p;if(b[E[0]].copy(c),S.vmult(c,c),c.vadd(N,c),c.vsub(this.origin,c),S.vmult(z,l),m=this.direction.dot(l),!(o>Math.abs(m))&&(w=l.dot(c)/m,!(0>w)&&0>m)){this.direction.mult(w,h),h.vadd(this.origin,h),b[E[0]].copy(a),S.vmult(a,a),N.vadd(a,a);for(var M=1;E.length-1>M;M++)if(b[E[M]].copy(s),b[E[M+1]].copy(u),S.vmult(s,s),S.vmult(u,u),N.vadd(s,s),N.vadd(u,u),r(h,a,s,u)){v={distance:this.origin.distanceTo(h),point:h.copy(),face:E,body:d},f.push(v);break}}}}return f},this.intersectBodies=function(t){for(var e=[],i=0,n=t.length;n>i;i++){var r=this.intersectBody(t[i]);Array.prototype.push.apply(e,r)}return e.sort(function(t,e){return t.distance-e.distance}),e};var p,d,v,f,y,m,w,g,b,x,V=new t.Vec3,E=new t.Vec3,z=new t.Vec3,S=new t.Vec3},t.Ray.prototype.constructor=t.Ray,t.Broadphase=function(){this.world=null,this.useBoundingBoxes=!1},t.Broadphase.prototype.constructor=t.BroadPhase,t.Broadphase.prototype.collisionPairs=function(){throw Error("collisionPairs not implemented for this BroadPhase class!")};var I=t.Body.STATIC|t.Body.KINEMATIC;t.Broadphase.prototype.needBroadphaseCollision=function(e,i){return 0===(e.collisionFilterGroup&i.collisionFilterMask)||0===(i.collisionFilterGroup&e.collisionFilterMask)?!1:0===(e.motionstate&I)&&!e.isSleeping()||0===(i.motionstate&I)&&!i.isSleeping()?e.shape||i.shape?e.shape instanceof t.Plane&&i.shape instanceof t.Plane?!1:!0:!1:!1},t.Broadphase.prototype.intersectionTest=function(t,e,i,n){this.useBoundingBoxes?this.doBoundingBoxBroadphase(t,e,i,n):this.doBoundingSphereBroadphase(t,e,i,n)};var B=new t.Vec3,C=new t.Vec3,O=(new t.Quaternion,new t.Vec3);t.Broadphase.prototype.doBoundingSphereBroadphase=function(e,i,n,r){var o=t.Shape.types,a=o.SPHERE|o.BOX|o.COMPOUND|o.CONVEXPOLYHEDRON,s=o.PLANE;t.Body.STATIC|t.Body.KINEMATIC;var u=B,c=C,l=O,h=e.shape,p=i.shape;if(h&&p){var d=h.type,v=p.type;if(d&a&&v&a){i.position.vsub(e.position,u),h.boundingSphereRadiusNeedsUpdate&&h.computeBoundingSphereRadius(),p.boundingSphereRadiusNeedsUpdate&&p.computeBoundingSphereRadius();var f=h.boundingSphereRadius+p.boundingSphereRadius;f*f>u.norm2()&&(n.push(e),r.push(i))}else if(d&a&&v&o.PLANE||v&a&&d&o.PLANE){var y=d===s?e:i,m=d!==s?e:i,w=m.shape,g=y.shape;m.position.vsub(y.position,u),g.worldNormalNeedsUpdate&&g.computeWorldNormal(y.quaternion),c=g.worldNormal,w.boundingSphereRadiusNeedsUpdate&&w.computeBoundingSphereRadius();var b=u.dot(c)-w.boundingSphereRadius;0>b&&(n.push(e),r.push(i))}}else if(h||p){var x=h?i:e,V=h?e:i,w=V.shape,E=w.type;if(E&a){if(E===o.SPHERE)x.position.vsub(V.position,l),w.radius*w.radius>=l.norm2()&&(n.push(x),r.push(V));else if(E===o.CONVEXPOLYHEDRON||E===o.BOX||E===o.COMPOUND){w.boundingSphereRadiusNeedsUpdate&&w.computeBoundingSphereRadius();var z=w.boundingSphereRadius;x.position.vsub(V.position,l),z*z>=l.norm2()&&(n.push(x),r.push(V))}}else if(E===o.PLANE){var S=V;c.set(0,0,1),S.quaternion.vmult(c,c),x.position.vsub(S.position,l),0>=c.dot(l)&&(n.push(x),r.push(V))}}else;},t.Broadphase.prototype.doBoundingBoxBroadphase=function(e,i,n,r){var o=e.shape,a=i.shape;if(e.aabbNeedsUpdate&&e.computeAABB(),i.aabbNeedsUpdate&&i.computeAABB(),o&&a)e.aabbmax.x<i.aabbmin.x||e.aabbmax.y<i.aabbmin.y||e.aabbmax.z<i.aabbmin.z||e.aabbmin.x>i.aabbmax.x||e.aabbmin.y>i.aabbmax.y||e.aabbmin.z>i.aabbmax.z||(n.push(e),r.push(i));else if(o||a){var s=o?i:e,u=o?e:i;u.shape instanceof t.Plane,s.position.x<u.aabbmin.x||s.position.y<u.aabbmin.y||s.position.z<u.aabbmin.z||s.position.x>u.aabbmax.x||s.position.y>u.aabbmax.y||s.position.z>u.aabbmax.z||(n.push(e),r.push(i))}else;};var R={},T=[],F=[];t.Broadphase.prototype.makePairsUnique=function(t,e){for(var i=R,n=T,r=F,o=t.length,a=0;a!==o;a++)n[a]=t[a],r[a]=e[a];t.length=0,e.length=0;for(var a=0;a!==o;a++){var s=n[a].id,u=r[a].id,c=u>s?s+","+u:u+","+s;i[c]=a}for(var c in i){var a=i[c];t.push(n[a]),e.push(r[a]),delete i[c]}},t.NaiveBroadphase=function(){t.Broadphase.apply(this)},t.NaiveBroadphase.prototype=new t.Broadphase,t.NaiveBroadphase.prototype.constructor=t.NaiveBroadphase,t.NaiveBroadphase.prototype.collisionPairs=function(t,e,i){var n,r,o,a,s=t.bodies,u=s.length;for(n=0;n!==u;n++)for(r=0;r!==n;r++)o=s[n],a=s[r],this.needBroadphaseCollision(o,a)&&this.intersectionTest(o,a,e,i)},t.GridBroadphase=function(e,i,n,r,o){t.Broadphase.apply(this),this.nx=n||10,this.ny=r||10,this.nz=o||10,this.aabbMin=e||new t.Vec3(100,100,100),this.aabbMax=i||new t.Vec3(-100,-100,-100),this.bins=[]},t.GridBroadphase.prototype=new t.Broadphase,t.GridBroadphase.prototype.constructor=t.GridBroadphase;var D=new t.Vec3,k=new t.Vec3;t.GridBroadphase.prototype.collisionPairs=function(e,i,n){var r=e.numObjects(),o=e.bodies,a=this.aabbMax,s=this.aabbMin,u=this.nx,c=this.ny,l=this.nz,h=a.x,p=a.y,d=a.z,v=s.x,f=s.y,y=s.z,m=u/(h-v),w=c/(p-f),g=l/(d-y),b=(h-v)/u,x=(p-f)/c,V=(d-y)/l,E=t.Shape.types,z=E.SPHERE,S=E.PLANE;E.BOX,E.COMPOUND,E.CONVEXPOLYHEDRON;for(var N=this.bins,M=u*c*l,j=N.length-1;j!==M;j++)N.push([]);for(var j=0;j!==M;j++)N[j].length=0;for(var P=Math.floor,j=0;j!==r;j++){var q=o[j],A=q.shape;switch(A.type){case z:for(var I=q.position.x,B=q.position.y,C=q.position.z,O=A.radius,R=P(m*(I-O-v)),T=P(w*(B-O-f)),F=P(g*(C-O-y)),U=P(m*(I+O-v)),W=P(w*(B+O-f)),_=P(g*(C+O-y)),L=R;L!==U+1;L++)for(var H=T;H!==W+1;H++)for(var Q=F;Q!==_+1;Q++){var X=L,G=H,Y=Q,Z=X*(c-1)*(l-1)+G*(l-1)+Y;Z>=0&&M>Z&&N[Z].push(q)}break;case S:var K=D,$=k,J=.25*(b*b+x*x+V*V),te=A.worldNormal;A.worldNormalNeedsUpdate&&A.computeWorldNormal(q.quaternion);for(var L=0;L!==u;L++)for(var H=0;H!==c;H++)for(var Q=0;Q!==l;Q++){var X=L,G=H,Y=Q;if($.set(X*b+v,G*x+f,Y*V+y),$.vsub(q.position,K),J>K.dot(te)){var Z=X*(c-1)*(l-1)+G*(l-1)+Y;N[Z].push(q)}}break;default:console.warn("Shape "+A.type+" not supported in GridBroadphase!")}}for(var j=0;j!==M;j++)for(var ee=N[j],L=0,ie=ee.length;L!==ie;L++)for(var q=ee[L],H=0;H!==L;H++){var ne=ee[H];this.needBroadphaseCollision(q,ne)&&this.intersectionTest(q,ne,i,n)}this.makePairsUnique(i,n)},t.Solver=function(){this.equations=[]},t.Solver.prototype.solve=function(){return 0},t.Solver.prototype.addEquation=function(t){this.equations.push(t)},t.Solver.prototype.removeEquation=function(t){var e=this.equations,i=e.indexOf(t);-1!==i&&e.splice(i,1)},t.Solver.prototype.removeAllEquations=function(){this.equations.length=0},t.GSSolver=function(){t.Solver.call(this),this.iterations=10,this.tolerance=0},t.GSSolver.prototype=new t.Solver;var U=[],W=[],_=[];t.GSSolver.prototype.solve=function(t,e){var i,n,r,o,a,s,u=(this.d,this.k,0),c=this.iterations,l=this.tolerance*this.tolerance,h=(this.a,this.b),p=this.equations,d=p.length,v=e.bodies,f=v.length,y=t,m=W,w=_,g=U;m.length=0,w.length=0,g.length=0;for(var b=0;b!==d;b++){var x=p[b];x.spookParamsNeedsUpdate&&(x.updateSpookParams(y),x.spookParamsNeedsUpdate=!1),g[b]=0,w[b]=x.computeB(y),m[b]=1/x.computeC()}if(0!==d){for(var b=0;b!==f;b++){var h=v[b],V=h.vlambda,E=h.wlambda;V.set(0,0,0),E&&E.set(0,0,0)}for(u=0;u!==c;u++){o=0;for(var z=0;z!==d;z++){var x=p[z];i=w[z],n=m[z],s=g[z],a=x.computeGWlambda(),r=n*(i-a-x.eps*s),x.minForce>s+r?r=x.minForce-s:s+r>x.maxForce&&(r=x.maxForce-s),g[z]+=r,o+=r>0?r:-r,x.addToWlambda(r)}if(l>o*o)break}for(var b=0;b!==f;b++){var h=v[b],S=h.velocity,N=h.angularVelocity;S.vadd(h.vlambda,S),N&&N.vadd(h.wlambda,N)}}return u},t.SplitSolver=function(e){t.Solver.call(this),this.subsolver=e},t.SplitSolver.prototype=new t.Solver;var L=[],H=[],Q=[],X={bodies:null};t.SplitSolver.prototype.solve=function(e,i){function n(t){for(var e=t.length,i=0;i!==e;i++){var n=t[i];if(!(n.visited||n.body.motionstate&b))return n}return!1}function r(t,e){var i=[];for(i.push(t),t.visited=!0,e(t);i.length;)for(var r,o=i.pop();r=n(o.children);)r.visited=!0,e(r),i.push(r)}function o(t){E.push(t.body);for(var e=t.eqs.length,i=0;i!==e;i++){var n=t.eqs[i];-1===V.indexOf(n)&&V.push(n)}}for(var a=L,s=i.bodies,u=this.equations,c=u.length,l=s.length,h=this.subsolver,p=a.length;p!==l;p++)a.push({body:s[p],children:[],eqs:[],visited:!1});for(var p=0;p!==l;p++){var d=a[p];d.body=s[p],d.children.length=0,d.eqs.length=0,d.visited=!1}for(var v=0;v!==c;v++){var f=u[v],p=s.indexOf(f.bi),y=s.indexOf(f.bj),m=a[p],w=a[y];m.children.push(w),m.eqs.push(f),w.children.push(m),w.eqs.push(f)}for(var g,b=t.Body.STATIC,x=0,V=H,E=Q,z=X;g=n(a);){V.length=0,E.length=0,r(g,o);for(var S=V.length,p=0;p!==S;p++)h.addEquation(V[p]);z.bodies=E,h.solve(e,z),h.removeAllEquations(),x++}return x},t.Material=function(t){this.name=t,this.id=-1},t.ContactMaterial=function(t,e,i,n){this.id=-1,this.materials=[t,e],this.friction=void 0!==i?Number(i):.3,this.restitution=void 0!==n?Number(n):.3,this.contactEquationStiffness=1e7,this.contactEquationRegularizationTime=3,this.frictionEquationStiffness=1e7,this.frictionEquationRegularizationTime=3},t.World=function(){t.EventTarget.apply(this),this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.last_dt=this.default_dt,this.nextId=0,this.gravity=new t.Vec3,this.broadphase=null,this.bodies=[],this.solver=new t.GSSolver,this.constraints=[],this.contactgen=new t.ContactGenerator,this.collisionMatrix=[],this.collisionMatrixPrevious=[],this.materials=[],this.contactmaterials=[],this.mats2cmat=[],this.defaultMaterial=new t.Material("default"),this.defaultContactMaterial=new t.ContactMaterial(this.defaultMaterial,this.defaultMaterial,.3,0),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,nearphase:0},this.subsystems=[]},t.World.prototype.getContactMaterial=function(e,i){if(e instanceof t.Material&&i instanceof t.Material){var n=e.id,r=i.id;if(r>n){var o=n;n=r,r=o}return this.contactmaterials[this.mats2cmat[n+r*this.materials.length]]}},t.World.prototype.numObjects=function(){return this.bodies.length},t.World.prototype.collisionMatrixGet=function(t,e,i){if(e>t){var n=e;e=t,t=n}return t=(t*(t+1)>>1)+e-1,i===void 0||i?this.collisionMatrix[t]:this.collisionMatrixPrevious[t]},t.World.prototype.collisionMatrixSet=function(t,e,i,n){if(e>t){var r=e;e=t,t=r}t=(t*(t+1)>>1)+e-1,n===void 0||n?this.collisionMatrix[t]=i:this.collisionMatrixPrevious[t]=i},t.World.prototype.collisionMatrixTick=function(){var t=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=t;for(var e=0,i=this.collisionMatrix.length;e!==i;e++)this.collisionMatrix[e]=0},t.World.prototype.add=function(e){e.id=this.id(),e.index=this.bodies.length,this.bodies.push(e),e.world=this,e.position.copy(e.initPosition),e.velocity.copy(e.initVelocity),e.timeLastSleepy=this.time,e instanceof t.RigidBody&&(e.angularVelocity.copy(e.initAngularVelocity),e.quaternion.copy(e.initQuaternion));var i=this.numObjects();this.collisionMatrix.length=i*(i-1)>>1},t.World.prototype.addConstraint=function(t){this.constraints.push(t),t.id=this.id()},t.World.prototype.removeConstraint=function(t){var e=this.constraints.indexOf(t);-1!==e&&this.constraints.splice(e,1)},t.World.prototype.id=function(){return this.nextId++},t.World.prototype.remove=function(t){t.world=null;var e=this.numObjects()-1,i=this.bodies;i.splice(t.index,1);for(var n=t.index;e>n;n++)i[n].index=n;this.collisionMatrixPrevious.length=this.collisionMatrix.length=e*(e-1)>>1},t.World.prototype.addMaterial=function(t){if(-1===t.id){var e=this.materials.length;this.materials.push(t),t.id=this.materials.length-1;for(var i=0;i!==2*e+1;i++)this.mats2cmat.push(-1)}},t.World.prototype.addContactMaterial=function(t){this.addMaterial(t.materials[0]),this.addMaterial(t.materials[1]);var e,i;t.materials[0].id>t.materials[1].id?(e=t.materials[0].id,i=t.materials[1].id):(i=t.materials[0].id,e=t.materials[1].id),this.contactmaterials.push(t),t.id=this.contactmaterials.length-1,this.mats2cmat[e+this.materials.length*i]=t.id},t.World.prototype._now=function(){return window.performance.webkitNow?window.performance.webkitNow():Date.now()};var G={type:"postStep"},Y={type:"collide","with":null,contact:null},Z=[],K=[],$=[],J=[],te=new t.Vec3,ee=(new t.Vec3,new t.Vec3,new t.Vec3,new t.Vec3,new t.Vec3,new t.Vec3,new t.Vec3,new t.Vec3,new t.Quaternion,new t.Quaternion),ie=new t.Quaternion;t.World.prototype.step=function(e){var i,n=this.contacts,r=$,o=J,a=this.numObjects(),s=this.bodies,u=this.solver,c=this.gravity,l=this.doProfiling,h=this.profile,p=t.Body.DYNAMIC,d=this._now,v=this.constraints,f=t.FrictionEquation,y=K,m=c.norm(),w=c.x,g=c.y,b=c.z,x=0;for(l&&(i=d()),void 0===e&&(e=this.last_dt||this.default_dt),x=0;x!==a;x++){var V=s[x];if(V.motionstate&p){var E=V.force,z=V.mass;E.x+=z*w,E.y+=z*g,E.z+=z*b}}for(var x=0,S=this.subsystems.length;x!==S;x++)this.subsystems[x].update();l&&(i=d()),r.length=0,o.length=0,this.broadphase.collisionPairs(this,r,o),l&&(h.broadphase=d()-i),this.collisionMatrixTick(),l&&(i=d());var N=Z,M=n.length;for(x=0;x!==M;x++)N.push(n[x]);n.length=0,this.contactgen.getContacts(r,o,this,n,N),l&&(h.nearphase=d()-i),l&&(i=d());var j=n.length,P=this.frictionEquations.length;for(x=0;x!==P;x++)y.push(this.frictionEquations[x]);this.frictionEquations.length=0;for(var q=0;q!==j;q++){var A=n[q],V=A.bi,I=A.bj,x=s.indexOf(V),B=s.indexOf(I),C=this.getContactMaterial(V.material,I.material)||this.defaultContactMaterial,O=C.friction;C.restitution;var R=te;R.set(I.position.x+A.rj.x-V.position.x-A.ri.x,I.position.y+A.rj.y-V.position.y-A.ri.y,I.position.z+A.rj.z-V.position.z-A.ri.z);var T=R.dot(A.ni);if(0>T){if(A.restitution=C.restitution,A.penetration=T,A.stiffness=C.contactEquationStiffness,A.regularizationTime=C.contactEquationRegularizationTime,u.addEquation(A),O>0){var F=O*m,D=V.invMass+I.invMass;D>0&&(D=1/D);var k=y,U=k.length?k.pop():new f(V,I,F*D),W=k.length?k.pop():new f(V,I,F*D);this.frictionEquations.push(U),this.frictionEquations.push(W),U.bi=W.bi=V,U.bj=W.bj=I,U.minForce=W.minForce=-F*D,U.maxForce=W.maxForce=F*D,A.ri.copy(U.ri),A.rj.copy(U.rj),A.ri.copy(W.ri),A.rj.copy(W.rj),A.ni.tangents(U.t,W.t),u.addEquation(U),u.addEquation(W)}this.collisionMatrixSet(x,B,1,!0),this.collisionMatrixGet(x,B,!0)!==this.collisionMatrixGet(x,B,!1)&&(Y.with=I,Y.contact=A,V.dispatchEvent(Y),Y.with=V,I.dispatchEvent(Y),V.wakeUp(),I.wakeUp())}}l&&(h.makeContactConstraints=d()-i),l&&(i=d());var _=v.length;for(x=0;x!==_;x++){var A=v[x];A.update();for(var B=0,L=A.equations.length;B!==L;B++){var H=A.equations[B];u.addEquation(H)}}u.solve(e,this),l&&(h.solve=d()-i),u.removeAllEquations();var Q=Math.pow;for(x=0;x!==a;x++){var V=s[x];if(V.motionstate&p){var X=Q(1-V.linearDamping,e),ne=V.velocity;ne.mult(X,ne);var re=V.angularVelocity;if(re){var oe=Q(1-V.angularDamping,e);re.mult(oe,re)}}}for(this.dispatchEvent(G),x=0;x!==a;x++){var V=s[x];V.preStep&&V.preStep.call(V)}l&&(i=d());var ae=ee,se=ie,ue=this.stepnumber,ce=t.Body.DYNAMIC|t.Body.KINEMATIC,le=0===ue%(this.quatNormalizeSkip+1),he=this.quatNormalizeFast,pe=.5*e,de=t.Shape.types.PLANE,ve=t.Shape.types.CONVEXPOLYHEDRON;for(x=0;x!==a;x++){var fe=s[x],ye=fe.shape,me=fe.force,we=fe.tau;if(fe.motionstate&ce){var ge=fe.velocity,be=fe.angularVelocity,xe=fe.position,Ve=fe.quaternion,Ee=fe.invMass,ze=fe.invInertia;if(ge.x+=me.x*Ee*e,ge.y+=me.y*Ee*e,ge.z+=me.z*Ee*e,fe.angularVelocity&&(be.x+=we.x*ze.x*e,be.y+=we.y*ze.y*e,be.z+=we.z*ze.z*e),fe.isSleeping()||(xe.x+=ge.x*e,xe.y+=ge.y*e,xe.z+=ge.z*e,fe.angularVelocity&&(ae.set(be.x,be.y,be.z,0),ae.mult(Ve,se),Ve.x+=pe*se.x,Ve.y+=pe*se.y,Ve.z+=pe*se.z,Ve.w+=pe*se.w,le&&(he?Ve.normalizeFast():Ve.normalize())),fe.aabbmin&&(fe.aabbNeedsUpdate=!0)),ye)switch(ye.type){case de:ye.worldNormalNeedsUpdate=!0;break;case ve:ye.worldFaceNormalsNeedsUpdate=!0,ye.worldVerticesNeedsUpdate=!0}}fe.force.set(0,0,0),fe.tau&&fe.tau.set(0,0,0)}for(l&&(h.integrate=d()-i),this.time+=e,this.stepnumber+=1,this.dispatchEvent(G),x=0;x!==a;x++){var V=s[x],Se=V.postStep;Se&&Se.call(V)}for(x=0;x!==a;x++){var fe=s[x];fe.inertiaWorldAutoUpdate&&fe.quaternion.vmult(fe.inertia,fe.inertiaWorld),fe.invInertiaWorldAutoUpdate&&fe.quaternion.vmult(fe.invInertia,fe.invInertiaWorld)}if(this.allowSleep)for(x=0;x!==a;x++)s[x].sleepTick(this.time)},t.ContactGenerator=function(){function e(e,i){if(y.length){var n=y.pop();return n.bi=e,n.bj=i,n}return new t.ContactEquation(e,i)}function i(t){var e;e=t.ri,t.ri=t.rj,t.rj=e,t.ni.negate(t.ni),e=t.bi,t.bi=t.bj,t.bj=e
}function n(t,i,n,r,o,a,s,u,c){var l=e(u,c);c.position.vsub(r,l.ni),l.ni.normalize(),l.ni.copy(l.ri),l.ni.copy(l.rj),l.ri.mult(i.radius,l.ri),l.rj.mult(-n.radius,l.rj),t.push(l)}function r(t,i,n,r,o,a,s,u,c){var l=e(u,c);l.ni.set(0,0,1),s.vmult(l.ni,l.ni),l.ni.negate(l.ni),l.ni.normalize(),l.ni.mult(i.radius,l.ri),r.vsub(o,w),l.ni.mult(l.ni.dot(w),g),w.vsub(g,l.rj),g.norm2()<=i.radius*i.radius&&t.push(l)}function o(t,e,i){for(var n=null,r=t.length,o=0;o!==r;o++){var a=t[o],s=b;t[(o+1)%r].vsub(a,s);var u=x;s.cross(e,u);var c=V;i.vsub(a,c);var l=u.dot(c);if(!(null===n||l>0&&n===!0||0>=l&&n===!1))return!1;null===n&&(n=l>0)}return!0}function a(t,i,n,r,o,a,s,u,c){var l=M;r.vsub(o,E),n.getSideNormals(l,s);for(var h=i.radius,p=!1,d=P,v=q,f=A,y=null,w=0,g=0,b=0,x=null,V=0,I=l.length;V!==I&&p===!1;V++){var B=z;l[V].copy(B);var C=B.norm();B.normalize();var O=E.dot(B);if(C+h>O&&O>0){var R=S,T=N;l[(V+1)%3].copy(R),l[(V+2)%3].copy(T);var F=R.norm(),D=T.norm();R.normalize(),T.normalize();var k=E.dot(R),U=E.dot(T);if(F>k&&k>-F&&D>U&&U>-D){var W=Math.abs(O-C-h);(null===x||x>W)&&(x=W,g=k,b=U,y=C,B.copy(d),R.copy(v),T.copy(f),w++)}}}if(w){p=!0;var _=e(u,c);d.mult(-h,_.ri),d.copy(_.ni),_.ni.negate(_.ni),d.mult(y,d),v.mult(g,v),d.vadd(v,d),f.mult(b,f),d.vadd(f,_.rj),t.push(_)}for(var L=m.get(),H=j,Q=0;2!==Q&&!p;Q++)for(var X=0;2!==X&&!p;X++)for(var G=0;2!==G&&!p;G++)if(L.set(0,0,0),Q?L.vadd(l[0],L):L.vsub(l[0],L),X?L.vadd(l[1],L):L.vsub(l[1],L),G?L.vadd(l[2],L):L.vsub(l[2],L),o.vadd(L,H),H.vsub(r,H),h*h>H.norm2()){p=!0;var _=e(u,c);H.copy(_.ri),_.ri.normalize(),_.ri.copy(_.ni),_.ri.mult(h,_.ri),L.copy(_.rj),t.push(_)}m.release(L),L=null;for(var Y=m.get(),Z=m.get(),_=m.get(),K=m.get(),W=m.get(),$=l.length,Q=0;Q!==$&&!p;Q++)for(var X=0;X!==$&&!p;X++)if(Q%3!==X%3){l[X].cross(l[Q],Y),Y.normalize(),l[Q].vadd(l[X],Z),r.copy(_),_.vsub(Z,_),_.vsub(o,_);var J=_.dot(Y);Y.mult(J,K);for(var G=0;G===Q%3||G===X%3;)G++;r.copy(W),W.vsub(K,W),W.vsub(Z,W),W.vsub(o,W);var te=Math.abs(J),ee=W.norm();if(l[G].norm()>te&&h>ee){p=!0;var ie=e(u,c);Z.vadd(K,ie.rj),ie.rj.copy(ie.rj),W.negate(ie.ni),ie.ni.normalize(),ie.rj.copy(ie.ri),ie.ri.vadd(o,ie.ri),ie.ri.vsub(r,ie.ri),ie.ri.normalize(),ie.ri.mult(h,ie.ri),t.push(ie)}}m.release(Y,Z,_,K,W)}function s(t,i,n,r,a,s,u,c,l){r.vsub(a,I);for(var h=n.faceNormals,p=n.faces,d=n.vertices,v=i.radius,f=0;f!==d.length;f++){var y=d[f],w=R;u.vmult(y,w),a.vadd(w,w);var g=O;if(w.vsub(r,g),v*v>g.norm2()){x=!0;var b=e(c,l);return g.copy(b.ri),b.ri.normalize(),b.ri.copy(b.ni),b.ri.mult(v,b.ri),w.vsub(a,b.rj),t.push(b),void 0}}for(var x=!1,f=0,V=p.length;f!==V&&x===!1;f++){var E=h[f],z=p[f],S=T;u.vmult(E,S);var N=F;u.vmult(d[z[0]],N),N.vadd(a,N);var M=D;S.mult(-v,M),r.vadd(M,M);var j=k;M.vsub(N,j);var P=j.dot(S),q=U;if(r.vsub(N,q),0>P&&q.dot(S)>0){for(var A=[],W=0,_=z.length;W!==_;W++){var L=m.get();u.vmult(d[z[W]],L),a.vadd(L,L),A.push(L)}if(o(A,S,r)){x=!0;var b=e(c,l);S.mult(-v,b.ri),S.negate(b.ni);var H=m.get();S.mult(-P,H);var Q=m.get();S.mult(-v,Q),r.vsub(a,b.rj),b.rj.vadd(Q,b.rj),b.rj.vadd(H,b.rj),m.release(H),m.release(Q),t.push(b);for(var W=0,X=A.length;W!==X;W++)m.release(A[W]);return}for(var W=0;W!==z.length;W++){var G=m.get(),Y=m.get();u.vmult(d[z[(W+1)%z.length]],G),u.vmult(d[z[(W+2)%z.length]],Y),a.vadd(G,G),a.vadd(Y,Y);var Z=B;Y.vsub(G,Z);var K=C;Z.unit(K);var $=m.get(),J=m.get();r.vsub(G,J);var te=J.dot(K);K.mult(te,$),$.vadd(G,$);var ee=m.get();if($.vsub(r,ee),te>0&&Z.norm2()>te*te&&v*v>ee.norm2()){var b=e(c,l);$.vsub(a,b.rj),$.vsub(r,b.ni),b.ni.normalize(),b.ni.mult(v,b.ri),t.push(b);for(var W=0,X=A.length;W!==X;W++)m.release(A[W]);return m.release(G),m.release(Y),m.release($),m.release(ee),m.release(J),void 0}m.release(G),m.release(Y),m.release($),m.release(ee),m.release(J)}for(var W=0,X=A.length;W!==X;W++)m.release(A[W])}}}function u(t,e,i,n,r,o,a,s,u){l(t,e,i.convexPolyhedronRepresentation,n,r,o,a,s,u)}function c(e,i,n,r,o,a,s,u,c){for(var l=W,h=_,p=0,d=0,v=n.childShapes.length;d!==v;d++){var y=[],m=h.pop()||new t.Quaternion,w=l.pop()||new t.Vec3;s.mult(n.childOrientations[d],m),m.normalize(),s.vmult(n.childOffsets[d],w),o.vadd(w,w),f(y,i,n.childShapes[d],r,w,a,m,u,c),h.push(m);var g=w;i||(p+=y.length);for(var b=0;b!==y.length;b++)s.vmult(n.childOffsets[d],g),y[b].rj.vadd(g,y[b].rj),e.push(y[b]);l.push(w)}}function l(t,i,n,r,o,a,s,u,c){var l=L,h=H;h.set(0,0,1),a.vmult(h,h);for(var p=Q,d=0;d!==n.vertices.length;d++){n.vertices[d].copy(l),s.vmult(l,l),o.vadd(l,l),l.vsub(r,p);var v=h.dot(p);if(0>=v){var f=X;h.mult(h.dot(l),f),l.vsub(f,f);var y=e(u,c);h.copy(y.ni),f.copy(y.ri),l.vsub(o,y.rj),t.push(y)}}}function h(t,i,n,r,o,a,s,u,c){var l=G;if(i.findSeparatingAxis(n,r,a,o,s,l)){var h=[],p=Y;i.clipAgainstHull(r,a,n,o,s,l,-100,100,h);for(var d=0;d!==h.length;d++){var v=e(u,c);l.negate(v.ni),h[d].normal.negate(p),p.mult(h[d].depth,p),h[d].point.vadd(p,v.ri),h[d].point.copy(v.rj),v.rj.vsub(o,v.rj),v.ri.vsub(r,v.ri),t.push(v)}}}function p(t,i,n,r,o,a,s,u,c){var l=Z;l.set(0,0,1),c.quaternion.vmult(l,l);var h=K;r.vsub(c.position,h);var p=l.dot(h);if(0>=p){var d=e(u,c);l.copy(d.ni),d.ni.negate(d.ni),d.ri.set(0,0,0);var v=$;l.mult(l.dot(r),v),r.vsub(v,v),v.copy(d.rj),t.push(d)}}function d(t,i,n,r,o,a,s,u,c){var l=J;l.set(0,0,1),r.vsub(o,l);var h=l.norm2();if(n.radius*n.radius>=h){var p=e(u,c);l.normalize(),l.copy(p.rj),p.rj.mult(n.radius,p.rj),l.copy(p.ni),p.ni.negate(p.ni),p.ri.set(0,0,0),t.push(p)}}function v(t,i,n,r,o,a,s,u,c){var l=-1,h=ie,p=re,d=null,v=0,f=ee;if(r.copy(f),f.vsub(o,f),s.conjugate(te),te.vmult(f,f),n.pointIsInside(f)){n.worldVerticesNeedsUpdate&&n.computeWorldVertices(o,s),n.worldFaceNormalsNeedsUpdate&&n.computeWorldFaceNormals(s);for(var y=0,m=n.faces.length;y!==m;y++){var w=[n.worldVertices[n.faces[y][0]]],g=n.worldFaceNormals[y];r.vsub(w[0],ne);var b=-g.dot(ne);(null===d||Math.abs(b)<Math.abs(d))&&(d=b,l=y,g.copy(h),v++)}if(-1!==l){var x=e(u,c);h.mult(d,p),p.vadd(r,p),p.vsub(o,p),p.copy(x.rj),h.negate(x.ni),x.ri.set(0,0,0),t.push(x)}else console.warn("Point found inside convex, but did not find penetrating face!")}}function f(e,o,y,m,w,g,b,x,V){var E=!1,z=t.Shape.types,S=z.SPHERE,N=z.PLANE,M=z.BOX,j=z.COMPOUND,P=z.CONVEXPOLYHEDRON;if(o&&y){if(o.type>y.type){var q;q=y,y=o,o=q,q=w,w=m,m=q,q=b,b=g,g=q,q=V,V=x,x=q,E=!0}}else if(o&&!y){var q;q=y,y=o,o=q,q=w,w=m,m=q,q=b,b=g,g=q,q=V,V=x,x=q,E=!0}if(o&&y){if(o.type===S)switch(y.type){case S:n(e,o,y,m,w,g,b,x,V);break;case N:r(e,o,y,m,w,g,b,x,V);break;case M:a(e,o,y,m,w,g,b,x,V);break;case j:c(e,o,y,m,w,g,b,x,V);break;case P:s(e,o,y,m,w,g,b,x,V);break;default:console.warn("Collision between CANNON.Shape.types.SPHERE and "+y.type+" not implemented yet.")}else if(o.type===z.PLANE)switch(y.type){case z.PLANE:throw Error("Plane-plane collision... wait, you did WHAT?");case z.BOX:u(e,o,y,m,w,g,b,x,V);break;case z.COMPOUND:c(e,o,y,m,w,g,b,x,V);break;case z.CONVEXPOLYHEDRON:l(e,o,y,m,w,g,b,x,V);break;default:console.warn("Collision between CANNON.Shape.types.PLANE and "+y.type+" not implemented yet.")}else if(o.type===z.BOX)switch(y.type){case z.BOX:f(e,o.convexPolyhedronRepresentation,y.convexPolyhedronRepresentation,m,w,g,b,x,V);break;case z.COMPOUND:c(e,o,y,m,w,g,b,x,V);break;case z.CONVEXPOLYHEDRON:f(e,o.convexPolyhedronRepresentation,y,m,w,g,b,x,V);break;default:console.warn("Collision between CANNON.Shape.types.BOX and "+y.type+" not implemented yet.")}else if(o.type===z.COMPOUND)switch(y.type){case z.COMPOUND:c(e,o,y,m,w,g,b,x,V);break;case z.CONVEXPOLYHEDRON:var A=[];c(A,y,o,w,m,b,g,V,x);for(var I=0;I!==A.length;I++)i(A[I]),e.push(A[I]);break;default:console.warn("Collision between CANNON.Shape.types.COMPOUND and "+y.type+" not implemented yet.")}else if(o.type===z.CONVEXPOLYHEDRON)switch(y.type){case z.CONVEXPOLYHEDRON:h(e,o,y,m,w,g,b,x,V);break;default:console.warn("Collision between CANNON.Shape.types.CONVEXPOLYHEDRON and "+y.type+" not implemented yet.")}}else switch(y.type){case z.PLANE:p(e,o,y,m,w,g,b,x,V);break;case z.SPHERE:d(e,o,y,m,w,g,b,x,V);break;case z.BOX:v(e,o,y.convexPolyhedronRepresentation,m,w,g,b,x,V);break;case z.CONVEXPOLYHEDRON:v(e,o,y,m,w,g,b,x,V);break;case z.COMPOUND:c(e,o,y,m,w,g,b,x,V);break;default:console.warn("Collision between CANNON.Particle and "+y.type+" not implemented yet.")}for(var B=0,C=e.length;E&&B!==C;B++)i(e[B])}this.contactReduction=!1;var y=[],m=new t.Vec3Pool,w=new t.Vec3,g=new t.Vec3,b=new t.Vec3,x=new t.Vec3,V=new t.Vec3,E=new t.Vec3,z=new t.Vec3,S=new t.Vec3,N=new t.Vec3,M=[new t.Vec3,new t.Vec3,new t.Vec3,new t.Vec3,new t.Vec3,new t.Vec3],j=new t.Vec3,P=new t.Vec3,q=new t.Vec3,A=new t.Vec3,I=new t.Vec3,B=new t.Vec3,C=new t.Vec3,O=new t.Vec3,R=new t.Vec3,T=new t.Vec3,F=new t.Vec3,D=new t.Vec3,k=new t.Vec3,U=new t.Vec3;new t.Vec3,new t.Vec3;var W=[],_=[],L=new t.Vec3,H=new t.Vec3,Q=new t.Vec3,X=new t.Vec3,G=new t.Vec3,Y=new t.Vec3,Z=new t.Vec3,K=new t.Vec3,$=new t.Vec3,J=new t.Vec3,te=new t.Quaternion,ee=new t.Vec3;new t.Vec3;var ie=new t.Vec3,ne=new t.Vec3,re=new t.Vec3;this.reduceContacts=function(){},this.getContacts=function(t,e,i,n,r){y=r;for(var o=0,a=t.length;o!==a;o++){var s=t[o],u=e[o];f(n,s.shape,u.shape,s.position,u.position,s.quaternion,u.quaternion,s,u)}}},t.Equation=function(t,e,i,n){this.id=-1,this.minForce=i===void 0?-1e6:i,this.maxForce=n===void 0?1e6:n,this.bi=t,this.bj=e,this.stiffness=1e7,this.regularizationTime=5,this.a=0,this.b=0,this.eps=0,this.spookParamsNeedsUpdate=!0},t.Equation.prototype.constructor=t.Equation,t.Equation.prototype.updateSpookParams=function(t){var e=this.regularizationTime,i=this.stiffness;this.a=4/(t*(1+4*e)),this.b=4*e/(1+4*e),this.eps=4/(t*t*i*(1+4*e))},t.ContactEquation=function(e,i){t.Equation.call(this,e,i,0,1e6),this.restitution=0,this.ri=new t.Vec3,this.rj=new t.Vec3,this.penetrationVec=new t.Vec3,this.ni=new t.Vec3,this.rixn=new t.Vec3,this.rjxn=new t.Vec3,this.invIi=new t.Mat3,this.invIj=new t.Mat3,this.biInvInertiaTimesRixn=new t.Vec3,this.bjInvInertiaTimesRjxn=new t.Vec3},t.ContactEquation.prototype=new t.Equation,t.ContactEquation.prototype.constructor=t.ContactEquation,t.ContactEquation.prototype.reset=function(){this.invInertiaTimesRxnNeedsUpdate=!0};var ne=new t.Vec3,re=new t.Vec3,oe=new t.Vec3;t.ContactEquation.prototype.computeB=function(t){var e=this.a,i=this.b,n=this.bi,r=this.bj,o=this.ri,a=this.rj,s=this.rixn,u=this.rjxn,c=oe,l=n.velocity,h=n.angularVelocity?n.angularVelocity:c,p=n.force,d=n.tau?n.tau:c,v=r.velocity,f=r.angularVelocity?r.angularVelocity:c,y=r.force,m=r.tau?r.tau:c,w=this.penetrationVec,g=n.invMass,b=r.invMass,x=this.invIi,V=this.invIj;n.invInertia?x.setTrace(n.invInertia):x.identity(),r.invInertia?V.setTrace(r.invInertia):V.identity();var E=this.ni;o.cross(E,s),a.cross(E,u);var w=this.penetrationVec;w.set(0,0,0),w.vadd(r.position,w),w.vadd(a,w),w.vsub(n.position,w),w.vsub(o,w);var z=E.dot(w),S=ne,N=re;x.vmult(d,S),V.vmult(m,N);var M=this.restitution+1,j=M*v.dot(E)-M*l.dot(E)+f.dot(u)-h.dot(s),P=y.dot(E)*b-p.dot(E)*g+u.dot(N)-s.dot(S),q=-z*e-j*i-t*P;return q},new t.Vec3,new t.Vec3,t.ContactEquation.prototype.computeC=function(){var t=this.bi,e=this.bj,i=this.rixn,n=this.rjxn,r=t.invMass,o=e.invMass,a=r+o+this.eps,s=this.invIi,u=this.invIj;return s.vmult(i,this.biInvInertiaTimesRixn),u.vmult(n,this.bjInvInertiaTimesRjxn),a+=this.biInvInertiaTimesRixn.dot(i),a+=this.bjInvInertiaTimesRjxn.dot(n)};var ae=new t.Vec3;t.ContactEquation.prototype.computeGWlambda=function(){var t=this.bi,e=this.bj,i=ae,n=0;return e.vlambda.vsub(t.vlambda,i),n+=i.dot(this.ni),t.wlambda&&(n-=t.wlambda.dot(this.rixn)),e.wlambda&&(n+=e.wlambda.dot(this.rjxn)),n};var se=new t.Vec3,ue=new t.Vec3;t.ContactEquation.prototype.addToWlambda=function(t){var e=this.bi,i=this.bj,n=(this.rixn,this.rjxn,e.invMass),r=i.invMass,o=this.ni,a=se,s=ue;o.mult(n*t,s),e.vlambda.vsub(s,e.vlambda),o.mult(r*t,s),i.vlambda.vadd(s,i.vlambda),void 0!==e.wlambda&&(this.biInvInertiaTimesRixn.mult(t,a),e.wlambda.vsub(a,e.wlambda)),void 0!==i.wlambda&&(this.bjInvInertiaTimesRjxn.mult(t,a),i.wlambda.vadd(a,i.wlambda))},t.FrictionEquation=function(e,i,n){t.Equation.call(this,e,i,-n,n),this.ri=new t.Vec3,this.rj=new t.Vec3,this.t=new t.Vec3,this.rixt=new t.Vec3,this.rjxt=new t.Vec3,this.wixri=new t.Vec3,this.wjxrj=new t.Vec3,this.invIi=new t.Mat3,this.invIj=new t.Mat3,this.relVel=new t.Vec3,this.relForce=new t.Vec3,this.biInvInertiaTimesRixt=new t.Vec3,this.bjInvInertiaTimesRjxt=new t.Vec3},t.FrictionEquation.prototype=new t.Equation,t.FrictionEquation.prototype.constructor=t.FrictionEquation;var ce=new t.Vec3,le=new t.Vec3,he=new t.Vec3;t.FrictionEquation.prototype.computeB=function(t){var e=this.a,i=this.b,n=this.bi,r=this.bj,o=this.ri,a=this.rj,s=this.rixt,u=this.rjxt,c=this.wixri,l=this.wjxrj,h=he,p=n.velocity,d=n.angularVelocity?n.angularVelocity:h,v=n.force,f=n.tau?n.tau:h,y=r.velocity,m=r.angularVelocity?r.angularVelocity:h,w=r.force,g=r.tau?r.tau:h,b=(this.relVel,this.relForce,n.invMass),x=r.invMass,V=this.invIi,E=this.invIj,z=this.t,S=ce,N=le;n.invInertia&&V.setTrace(n.invInertia),r.invInertia&&E.setTrace(r.invInertia),o.cross(z,s),a.cross(z,u),d.cross(o,c),m.cross(a,l),V.vmult(f,S),E.vmult(g,N);var M=0,j=y.dot(z)-p.dot(z)+l.dot(z)-c.dot(z),P=w.dot(z)*x-v.dot(z)*b+u.dot(N)-s.dot(S),q=-M*e-j*i-t*P;return q},t.FrictionEquation.prototype.computeC=function(){var t=this.bi,e=this.bj,i=this.rixt,n=this.rjxt,r=t.invMass,o=e.invMass,a=r+o+this.eps,s=this.invIi,u=this.invIj;return s.vmult(i,this.biInvInertiaTimesRixt),u.vmult(n,this.bjInvInertiaTimesRjxt),a+=this.biInvInertiaTimesRixt.dot(i),a+=this.bjInvInertiaTimesRjxt.dot(n)};var pe=new t.Vec3;t.FrictionEquation.prototype.computeGWlambda=function(){var t=this.bi,e=this.bj,i=0,n=pe;return e.vlambda.vsub(t.vlambda,n),i+=n.dot(this.t),t.wlambda&&(i-=t.wlambda.dot(this.rixt)),e.wlambda&&(i+=e.wlambda.dot(this.rjxt)),i};var de=new t.Vec3;t.FrictionEquation.prototype.addToWlambda=function(t){var e=this.bi,i=this.bj,n=(this.rixt,this.rjxt,e.invMass),r=i.invMass,o=this.t,a=de,s=e.wlambda,u=i.wlambda;o.mult(n*t,a),e.vlambda.vsub(a,e.vlambda),o.mult(r*t,a),i.vlambda.vadd(a,i.vlambda),s&&(this.biInvInertiaTimesRixt.mult(t,a),s.vsub(a,s)),u&&(this.bjInvInertiaTimesRjxt.mult(t,a),u.vadd(a,u))},t.RotationalEquation=function(e,i){t.Equation.call(this,e,i,-1e6,1e6),this.ni=new t.Vec3,this.nj=new t.Vec3,this.nixnj=new t.Vec3,this.njxni=new t.Vec3,this.invIi=new t.Mat3,this.invIj=new t.Mat3,this.relVel=new t.Vec3,this.relForce=new t.Vec3},t.RotationalEquation.prototype=new t.Equation,t.RotationalEquation.prototype.constructor=t.RotationalEquation,t.RotationalEquation.prototype.computeB=function(e){var i=this.a,n=this.b,r=this.bi,o=this.bj,a=this.ni,s=this.nj,u=this.nixnj,c=this.njxni;r.velocity;var l=r.angularVelocity?r.angularVelocity:new t.Vec3;r.force,r.tau?r.tau:new t.Vec3,o.velocity;var h=o.angularVelocity?o.angularVelocity:new t.Vec3;o.force,o.tau?o.tau:new t.Vec3,r.invMass,o.invMass;var p=this.invIi,d=this.invIj;r.invInertia?p.setTrace(r.invInertia):p.identity(),o.invInertia?d.setTrace(o.invInertia):d.identity(),a.cross(s,u),s.cross(a,c);var v=-a.dot(s),f=c.dot(l)+u.dot(h),y=0,m=-v*i-f*n-e*y;return m},t.RotationalEquation.prototype.computeC=function(){var t=this.bi,e=this.bj,i=this.nixnj,n=this.njxni;t.invMass,e.invMass;var r=this.eps,o=this.invIi,a=this.invIj;return t.invInertia?o.setTrace(t.invInertia):o.identity(),e.invInertia?a.setTrace(e.invInertia):a.identity(),r+=o.vmult(n).dot(n),r+=a.vmult(i).dot(i)};var ae=new t.Vec3;t.RotationalEquation.prototype.computeGWlambda=function(){var t=this.bi,e=this.bj,i=0;return t.wlambda&&(i+=t.wlambda.dot(this.njxni)),e.wlambda&&(i+=e.wlambda.dot(this.nixnj)),i},t.RotationalEquation.prototype.addToWlambda=function(t){var e=this.bi,i=this.bj,n=this.nixnj;if(this.njxni,e.invMass,i.invMass,e.wlambda){var r=this.invIi;e.wlambda.vsub(r.vmult(n).mult(t),e.wlambda)}if(i.wlambda){var r=this.invIj;i.wlambda.vadd(r.vmult(n).mult(t),i.wlambda)}},t.Constraint=function(t,e){this.equations=[],this.bodyA=t,this.bodyB=e},t.Constraint.prototype.update=function(){throw Error("method update() not implmemented in this Constraint subclass!")},t.DistanceConstraint=function(e,i,n,r){t.Constraint.call(this,e,i),r===void 0&&(r=1e6);var o=this.equations=[new t.ContactEquation(e,i)],a=o[0];a.minForce=-r,a.maxForce=r,this.update=function(){i.position.vsub(e.position,a.ni),a.ni.normalize(),a.ni.mult(.5*n,a.ri),a.ni.mult(.5*-n,a.rj)}},t.DistanceConstraint.prototype=new t.Constraint,t.RotationalMotorEquation=function(e,i,n){n=n||1e6,t.Equation.call(this,e,i,-n,n),this.axisA=new t.Vec3,this.axisB=new t.Vec3,this.invIi=new t.Mat3,this.invIj=new t.Mat3,this.targetVelocity=0},t.RotationalMotorEquation.prototype=new t.Equation,t.RotationalMotorEquation.prototype.constructor=t.RotationalMotorEquation,t.RotationalMotorEquation.prototype.computeB=function(e){var i=this.a,n=this.b,r=this.bi,o=this.bj,a=this.axisA,s=this.axisB;r.velocity;var u=r.angularVelocity?r.angularVelocity:new t.Vec3;r.force,r.tau?r.tau:new t.Vec3,o.velocity;var c=o.angularVelocity?o.angularVelocity:new t.Vec3;o.force,o.tau?o.tau:new t.Vec3,r.invMass,o.invMass;var l=this.invIi,h=this.invIj;r.invInertia?l.setTrace(r.invInertia):l.identity(),o.invInertia?h.setTrace(o.invInertia):h.identity();var p=0,d=a.dot(u)+s.dot(c)+this.targetVelocity,v=0,f=-p*i-d*n-e*v;return f},t.RotationalMotorEquation.prototype.computeC=function(){var t=this.bi,e=this.bj,i=this.axisA,n=this.axisB;t.invMass,e.invMass;var r=this.eps,o=this.invIi,a=this.invIj;return t.invInertia?o.setTrace(t.invInertia):o.identity(),e.invInertia?a.setTrace(e.invInertia):a.identity(),r+=o.vmult(i).dot(n),r+=a.vmult(n).dot(n)};var ae=new t.Vec3;t.RotationalMotorEquation.prototype.computeGWlambda=function(){var t=this.bi,e=this.bj,i=this.axisA,n=this.axisB,r=0;return t.wlambda&&(r+=t.wlambda.dot(i)),e.wlambda&&(r+=e.wlambda.dot(n)),r},t.RotationalMotorEquation.prototype.addToWlambda=function(t){var e=this.bi,i=this.bj,n=this.axisA,r=this.axisB;if(e.invMass,i.invMass,e.wlambda){var o=this.invIi;e.wlambda.vsub(o.vmult(n).mult(t),e.wlambda)}if(i.wlambda){var o=this.invIj;i.wlambda.vadd(o.vmult(r).mult(t),i.wlambda)}},t.HingeConstraint=function(e,i,n,r,o,a,s){t.Constraint.call(this,e,r),s=s||1e6;var u=this,c=this.equations=[new t.RotationalEquation(e,r),new t.RotationalEquation(e,r),new t.ContactEquation(e,r),new t.ContactEquation(e,r),new t.ContactEquation(e,r)];this.getRotationalEquation1=function(){return c[0]},this.getRotationalEquation2=function(){return c[1]},this.getPointToPointEquation1=function(){return c[2]},this.getPointToPointEquation2=function(){return c[3]},this.getPointToPointEquation3=function(){return c[4]};var l,h=this.getRotationalEquation1(),p=this.getRotationalEquation2(),d=this.getPointToPointEquation1(),v=this.getPointToPointEquation2(),f=this.getPointToPointEquation3();v.minForce=f.minForce=d.minForce=-s,v.maxForce=f.maxForce=d.maxForce=s;var y=i.unit(),m=o.unit(),w=new t.Vec3,g=new t.Vec3,b=new t.Vec3;n.cross(y,w),n.cross(w,g),a.cross(m,b),w.normalize(),b.normalize();var x=!1;this.motorTargetVelocity=0,this.motorMinForce=-s,this.motorMaxForce=s,this.enableMotor=function(){x||(l=new t.RotationalMotorEquation(e,r,s),c.push(l),x=!0)},this.disableMotor=function(){x&&(x=!1,l=null,c.pop())},this.update=function(){d.ni.set(1,0,0),v.ni.set(0,1,0),f.ni.set(0,0,1),e.quaternion.vmult(i,d.ri),r.quaternion.vmult(o,d.rj),d.ri.copy(v.ri),d.rj.copy(v.rj),d.ri.copy(f.ri),d.rj.copy(f.rj),e.quaternion.vmult(w,h.ni),r.quaternion.vmult(a,h.nj),e.quaternion.vmult(g,p.ni),r.quaternion.vmult(a,p.nj),x&&(e.quaternion.vmult(n,l.axisA),r.quaternion.vmult(a,l.axisB),l.targetVelocity=u.motorTargetVelocity,l.maxForce=u.motorMaxForce,l.minForce=u.motorMinForce)}},t.HingeConstraint.prototype=new t.Constraint,t.PointToPointConstraint=function(e,i,n,r,o){t.Constraint.call(this,e,n);var a=this.equations=[new t.ContactEquation(e,n),new t.ContactEquation(e,n),new t.ContactEquation(e,n)],s=a[0],u=a[1],c=a[2];u.minForce=c.minForce=s.minForce=-o,u.maxForce=c.maxForce=s.maxForce=o,this.update=function(){n.position.vsub(e.position,s.ni),s.ni.normalize(),e.quaternion.vmult(i,s.ri),n.quaternion.vmult(r,s.rj),s.ni.tangents(u.ni,c.ni),s.ri.copy(u.ri),s.rj.copy(u.rj),s.ri.copy(c.ri),s.rj.copy(c.rj)}},t.PointToPointConstraint.prototype=new t.Constraint,"undefined"!=typeof module?module.exports=t:this.CANNON=t}.apply(this),i("cannon",function(t){return function(){var e;return e||t.CANNON}}(this)),i("compound_mesh",["underscore","mesh","cannon"],function(t,e,i){function n(t,e){return e||(e=new THREE.Vector3(1,1,1)),t.parent&&(e=n(t.parent,e)),e.multiply(t.scale),e}function r(t,i,n){e.call(this,t,i,n)}if(window.VAPI===void 0||window.VAPI.VeroldApp===void 0)throw Error("VAPI.VeroldApp does not exist!");return r.prototype=t.extend({},e.prototype,{create:function(){var t,e=new i.Compound;this.model.traverse(function(t){var r,o,a,s;(t instanceof MeshObject||t instanceof SkinnedMeshObject)&&(s=n(t.threeData),t.threeData.geometry.computeBoundingBox(),o=t.threeData.geometry.boundingBox.max.clone(),o.sub(t.threeData.geometry.boundingBox.min),o.multiplyScalar(.5),a=new THREE.Vector3,t.threeData.parent&&a.add(t.threeData.parent.position.clone().multiply(t.threeData.parent.scale)),a.add(t.threeData.position.clone().multiply(t.threeData.scale)),a.add(t.threeData.geometry.boundingBox.min),a.add(o),a.multiply(s),o.multiply(s),r=new i.Box(new i.Vec3(o.x,o.y,o.z)),e.addChild(r,new i.Vec3(a.x,a.y,a.z),new i.Quaternion(t.threeData.quaternion.x,t.threeData.quaternion.y,t.threeData.quaternion.z,t.threeData.quaternion.w)))}),t=new i.RigidBody(this.mass,e),t.position.set(this.model.threeData.position.x,this.model.threeData.position.y,this.model.threeData.position.z),t.quaternion.set(this.model.threeData.quaternion.x,this.model.threeData.quaternion.y,this.model.threeData.quaternion.z,this.model.threeData.quaternion.w),t.linearDamping=this.linearDamping,t.angularDamping=this.angularDamping,this.world.add(t),this.model.cannonData=t,this.model.cannonAppData=this,this.created()}}),r}),i("cannon_app",["underscore","compound_mesh","cannon"],function(t,e,i){if(window.VAPI===void 0||window.VAPI.VeroldApp===void 0)throw Error("VAPI.VeroldApp does not exist!");var n=window.VAPI.CannonApp=window.VAPI.VeroldApp.extend({constructor:function(){window.VAPI.VeroldApp.prototype.constructor.apply(this,arguments),this.bodies=[]},engineReady:function(){var t=this;this.loadScene(this.defaultSceneID,{success_hierarchy:function(e){t.defaultScene=e,t.trigger("cannon:pre_init",e),t.initializeCannon(e),t.trigger("cannon:post_init",e),t.defaultSceneLoaded(e),t.veroldEngine.on("update",t.update,t),t.veroldEngine.on("fixedUpdate",t.fixedUpdate,t)},progress:function(e){t.defaultSceneProgress(e)}})},initializeCannon:function(t){var e,n,r=this,o=0,a=-9.82,s=0;t.entityModel.has("payload.userData.gravityX")&&(o=t.entityModel.get("payload.userData.gravityX")),t.entityModel.has("payload.userData.gravityY")&&(a=t.entityModel.get("payload.userData.gravityY")),t.entityModel.has("payload.userData.gravityZ")&&(s=t.entityModel.get("payload.userData.gravityZ")),this.world=new i.World,this.world.gravity.set(o,a,s),this.world.broadphase=new i.NaiveBroadphase,this.world.solver.iterations=7,this.world.solver.tolerance=.1,this.world.defaultContactMaterial.contactEquationStiffness=1e9,this.world.defaultContactMaterial.contactEquationRegularizationTime=4,n=new i.Plane,e=new i.RigidBody(0,n),e.position.set(0,0,0),e.quaternion.setFromAxisAngle(new i.Vec3(-1,0,0),.5*Math.PI),this.world.add(e),this.defaultScene.traverse(function(t){t instanceof ModelObject&&r.addBody(t)})},fixedUpdate:function(e){this.world.step(e),t.each(this.bodies,function(t){t.update(e)},this)},update:function(){},addBody:function(t){this.bodies.push(new e(this.world,t))}});return n}),e("cannon_app")});